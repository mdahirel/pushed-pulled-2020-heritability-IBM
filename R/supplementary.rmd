---
title: 'supplementary'
author: "Maxime Dahirel & Chlo√© Guicharnaud"
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

```{r load-packages}
library(arm)
library(matrixStats)
library(tidyverse)
library(cowplot)
library(patchwork)
library(tidybayes)


library(cmdstanr)
library(brms)
options(mc.cores = 4)

library(tidyverse)

library(here)
```



```{r}
raw_data <- read_csv(here("NetLogo_output","model-output.csv"))
```

We rewrite variance variables to be in 0/1 mode to not be distracted

```{r}
data<- raw_data  %>% 
  mutate(is.VP_dmax=as.numeric(VP_logit_dmax >0),
           is.VP_DDD=as.numeric(VP_slope >0))
```

what width do we use to define a "front" for sampling purposes?


```{r}
##supplementary plot to justify arbitrary front size =5 ish

data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_predispersal>0))) %>% ###works with pre or post
  filter(pxcor>front-10) %>% ### do same plot with core
  ggplot()+
  geom_boxplot(aes(factor(front-pxcor),N_predispersal))+ ##works with pre or post
  geom_hline(aes(yintercept = K),col="red")+
  geom_vline(xintercept = 7,col="red")+
 facet_grid(rows=vars(dispersal_mortality,VP_logit_dmax),
               cols=vars(heritability,VP_slope))
```


# checking evolutionary and velocity convergence


```{r}
tab_dynamics<-data %>% 
  group_by(replicateID,ticks,dispersal_mortality,is.VP_dmax,is.VP_DDD,heritability) %>% 
  summarise(front=max(pxcor*(N_postdispersal>0))) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  arrange(ticks) %>% 
  mutate(prev_front=lag(front)) %>% 
  mutate(prev_front=replace_na(prev_front,0)) %>% 
  mutate(speed_segment=(front-prev_front)/20) %>% 
  mutate(overall_speed=subset(front,ticks==120)/120) %>% 
  ungroup()

  ggplot(tab_dynamics)+
  geom_boxplot(aes(factor(ticks),speed_segment-overall_speed))+
  #facet_grid(rows=vars(dispersal_mortality,is.VP_dmax),
  #             cols=vars(heritability,is.VP_DDD))+
  scale_y_continuous("deviation from overall velocity (in patches per generation)")+
  scale_x_discrete("time interval (generations)",
                   labels=c("0-20","20-40","40-60","60-80","80-100","100-120"))+
  theme(legend.position = "none")

```




takeaway: convergence in speed (which depends on both the stochasticity of the invasion smoothing itself out and the evolutionary process finishing) is fast, and speeds at g100 or g120 can reasonably be used as measures of long-run speed

let's do the same to look at evolutionary stability at the edge


(we can NOT use "check if vA falls to zero" as a check for evolutionary stability, because in case of branching within a replicate, dynamics can be stable but vA very high, even higher than at t0 if "core" of the genotypic distri has been carved out)
(well we can, but we have to caveat it)

lots of things to do to strengthen this, but we can carry on assuming convergence at g100 for the enxt steps

```{r}
data %>% 
  filter(heritability>0) %>% 
  mutate(is.VP_dmax=as.numeric(VP_logit_dmax >0),
           is.VP_DDD=as.numeric(VP_slope >0)) %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor>front-5) %>%  
  group_by(replicateID,ticks,heritability,is.VP_dmax,is.VP_DDD,dispersal_mortality,
           VP_logit_dmax,VP_slope,VP_midpoint) %>%
  mutate(var_genotype_logit_dmax=replace_na(var_genotype_logit_dmax,0),
         var_genotype_midpoint=replace_na(var_genotype_midpoint,0),
         var_genotype_slope=replace_na(var_genotype_slope,0)) %>% 
  summarise(var_genotype_logit_dmax=weighted.mean(var_genotype_logit_dmax,N_predispersal,na.rm=TRUE),
            var_genotype_midpoint=weighted.mean(var_genotype_midpoint,N_predispersal,na.rm=TRUE),
            var_genotype_slope=weighted.mean(var_genotype_slope,N_predispersal,na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(
    is.fixed_dmax=var_genotype_logit_dmax<(0.05*VP_logit_dmax),
    is.fixed_slope=var_genotype_slope<(0.05*VP_slope),
    is.fixed_midpoint=var_genotype_midpoint<(0.05*VP_midpoint)
  ) %>% 
  group_by(ticks,heritability,is.VP_dmax,is.VP_DDD,dispersal_mortality) %>% 
  summarise(prop_dmax=mean(is.fixed_dmax),
            prop_slope=mean(is.fixed_slope),
            prop_midpoint=mean(is.fixed_midpoint)) %>% 
  ggplot()+
  geom_line(aes(ticks,prop_midpoint))+
  facet_grid(rows=vars(dispersal_mortality,is.VP_dmax),
               cols=vars(heritability,is.VP_DDD))+
  scale_y_continuous("proportion of replicates with <5% of initial genetic variation remaining at the edge")+
  scale_x_continuous("generations")+
  theme(legend.position = "none")
```


## comparing core and edge

# making sub data tables

a table with summary variables at the edge (we define edge as patch <5 patchs from tip, see suppl for justification)
```{r}
tab_edge<-data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor > front-5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    min_N=min(N_predispersal,na.rm=TRUE),
    max_N=max(N_predispersal,na.rm=TRUE),
    mean_dmax=weighted.mean(mean_dmax,N_predispersal,na.rm=TRUE),
    mean_slope=weighted.mean(mean_slope,N_predispersal,na.rm=TRUE),
    mean_midpoint=weighted.mean(mean_midpoint,N_predispersal,na.rm=TRUE),
    mean_d0=weighted.mean(mean_d0,N_predispersal,na.rm=TRUE),
    mean_avgslope=weighted.mean(mean_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_Kslope=weighted.mean(mean_slopeA_0_K,N_predispersal,na.rm=TRUE),
    mean_uncond=weighted.mean(mean_uncond_0_K,N_predispersal,na.rm=TRUE),
    mean_varslope=weighted.mean(var_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_vard0=weighted.mean(var_d0,N_predispersal,na.rm=TRUE),
    front=mean(front)
  ) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  mutate(range_N=max(max_N)-min(min_N)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD,
                          range_N),
              names_from=ticks,
              values_from=c(mean_dmax,mean_slope,mean_midpoint,
                            mean_d0,mean_avgslope,mean_Kslope,mean_uncond,
                            mean_varslope,mean_vard0,
                            front)) %>% 
  mutate(where="edge")
```

we do the same for core patches

```{r}
tab_core<-data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor < 5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    min_N=min(N_predispersal,na.rm=TRUE),
    max_N=max(N_predispersal,na.rm=TRUE),
    mean_dmax=weighted.mean(mean_dmax,N_predispersal,na.rm=TRUE),
    mean_slope=weighted.mean(mean_slope,N_predispersal,na.rm=TRUE),
    mean_midpoint=weighted.mean(mean_midpoint,N_predispersal,na.rm=TRUE),
    mean_d0=weighted.mean(mean_d0,N_predispersal,na.rm=TRUE),
    mean_avgslope=weighted.mean(mean_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_Kslope=weighted.mean(mean_slopeA_0_K,N_predispersal,na.rm=TRUE),
    mean_uncond=weighted.mean(mean_uncond_0_K,N_predispersal,na.rm=TRUE),
    mean_varslope=weighted.mean(var_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_vard0=weighted.mean(var_d0,N_predispersal,na.rm=TRUE),
    front=mean(front)
  ) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  mutate(range_N=max(max_N)-min(min_N)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD,
                          range_N),
              names_from=ticks,
              values_from=c(mean_dmax,mean_slope,mean_midpoint,
                            mean_d0,mean_avgslope,mean_Kslope,mean_uncond,
                            mean_varslope,mean_vard0,
                            front)) %>% 
  mutate(where="core")
```
