---
title: 'Supplementary Material for "Individual variation in dispersal, and its sources, shape the fate of pushed vs. pulled range expansions"'
author: "Maxime Dahirel, Chlo√© Guicharnaud, Elodie Vercken"
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE)
```

```{r load-packages}
library(arm)         # CRAN v1.11-2
library(matrixStats) # CRAN v0.60.0
library(tidyverse)   # CRAN v1.3.1 # CRAN v1.3.1
library(cowplot)     # [github::wilkelab/cowplot] v1.1.1
library(patchwork)   # CRAN v1.1.1
library(ggdist)      # CRAN v3.0.0
library(ggtext)      # CRAN v0.1.1

library(tidyverse)   # CRAN v1.3.1 # CRAN v1.3.1

library(here)        # CRAN v1.0.1
```

# S1 - Effect of the magnitude of initial variation in $\alpha$ on density dependence

In the main text, we discuss how allowing for negative $\beta$ is the only way we have to create mostly flat dispersal-density function where dispersal is close to $d_{max}$. We briefly explain that one seeming alternative, allowing very large $|\alpha|$ values so that dispersal goes from 0 to $d_{max}$ in less than 1 individual, is not viable. We expand this argument here:

- first, using $\alpha$ in this way would mean that $d_{0}$ becomes, in a way, a by-product of adjusting the shape of the curve, rather than its own trait of interest. This is not a good option when studying pushed vs. pulled expansions;

- second, we'd need the initial trait distribution to contain both these very large $\alpha$ (positive and negative) *and* $\alpha$ close to 0, for evolution to be possible. It's easy to demonstrate that distributions that fulfill this requirement are actually biased towards very sharp density-dispersal functions. If we assume $K = 250$ as in our simulations, then $\alpha = 1000$ (with $\beta$ very close to 0) is needed to generate one of these nearly flat functions:

<br/>

```{r fig-s1-1, fig.width=4, fig.height=4}
tab<- expand_grid(
  K=250,
  x=0:50)

dmax <- 0.5
alpha <- 1000
beta <- 0.000000000000001
  
ggplot(tab)+
  geom_line(aes(x,dmax/(1+exp(-alpha*(x/K-beta)))))+
  scale_x_continuous("Population size")+
  scale_y_continuous("Dispersal rate")+
  geom_vline(xintercept = 1, lty=2)+
  geom_hline(yintercept = 0.95*0.5, lty=2)+
  coord_cartesian(ylim=c(0,0.6))+
  theme_bw()
```

**Figure S1.1**. Example of how one can produce a functionally flat density-dispersal function using a very sharp slope, but very close to $N = 0$. $d_{max} = 0.5$, $\alpha = 1000$, $\beta = 10^{-15}$. The dashed lines mark $N=1$ (vertical) and $d_{N}=0.95 \times d_{max}$ (horizontal).

<br/>

So, even after setting $\beta$ absurdly close to 0, we still need $\alpha$ in the neighbourhood of 1000 to be able to produce such shapes (when, as a reminder, $\alpha=6$ is needed to get a slope that takes a population increase of $K$ individuals to go from 5% to 95% of $d_{max}$, so a reasonably shallow, but not too shallow function). An initial distribution of $\alpha$ of $\mathrm{Normal}(0,500)$ would hit these extreme $\alpha$ with a low but non-negligible probability (about 5%). And we know (see main text) that $6/\alpha$ expresses (in units of $K$) how sharp the increase in dispersal with density is. Let's have a look at the distribution of $6/|\alpha|$ implied by $\alpha \sim \mathrm{Normal}(0,500)$ :

<br/>

```{r fig-s1-2, fig.width=6, fig.height=5}
set.seed(42)
tibble(x=rnorm(10000,0,500)) %>% 
  ggplot()+
  geom_histogram(aes(6/abs(x)),binwidth = 0.1)+
  geom_vline(xintercept = 1, lty=2)+
  coord_cartesian(xlim=c(0,5))+
  scale_x_continuous("increase in density needed to go from 5% *d<sub>max</sub>* to 95% *d<sub>max</sub>* (or vice-versa)",
                     breaks=c(0:5),
                     labels=c(0,"1*K*","2*K*","3*K*","4*K*","5*K*"))+
  theme_bw()+
    theme(
    axis.title.x = element_markdown(),
    axis.text.x = element_markdown())
```

**Figure S1.2**. Distribution of the increases in density needed to go from 5% of $d_{max}$ to 95%, assuming $\alpha \sim \mathrm{Normal}(0,500)$. Histogram drawn based on 1000 samples.

<br/>

It's easy to see that this initial distribution of $\alpha$ would almost only allow sharp slopes, that take less than 20-50%$K$ to go from 0 to $d_{max}$, and disallow shallower slopes. This is not a choice that is ecologically sound in our opinion, hence why we rejected "extreme $\alpha$" as a method to generate $d_{N} \simeq d_{max}$ functions.

# S2 - How do we define the "range front"?

```{r load-data}
### let's start by loading the data
data <- read_csv(here("NetLogo_output","simulation_output.csv"))  %>% 
  mutate(is.VP_dmax=as.numeric(VP_logit_dmax >0),
           is.VP_DDD=as.numeric(VP_slope >0))
```

We are interested in how traits at the front of the expansion are shaped by, and shape, the expansion process. To do that right, we need an operational definition of what is the front. A "traditional" one is the range of patches where a density gradient is seen, i.e. where population density has not yet reached its equilibrium<!--ref-->. Let's have a look: 

<br/>

```{r fig-s2-1, fig.width=6, fig.height=8}
##supplementary plot to explain arbitrary front size = 5

#we use predispersal population size since that's when traits are recorded,
# but the principle should work the same post-dispersal
data %>%
  filter(N_predispersal > 0) %>%
  group_by(replicateID, ticks) %>% # for each time x replicate 
  mutate(edge_pxcor = max(pxcor)) %>%
  ungroup() %>% 
  filter(pxcor>edge_pxcor-20 & pxcor<=edge_pxcor) %>%
  ggplot()+
  geom_boxplot(
    aes(edge_pxcor-pxcor,N_predispersal,
        group=edge_pxcor-pxcor),
    col="grey40"
    )+ ##works with pre or post
  scale_x_continuous("distance to edge (# of patches)")+
  scale_y_continuous("pre-dispersal population size")+
  geom_vline(xintercept = c(4.5),col="red")+
  facet_grid(rows=vars(
                       paste("*r<sub>0</sub>* = log(",fecundity,")"),
                       paste("*m* =",dispersal_mortality)),
               cols=vars(paste("*h^2*=",heritability)))+
  theme_bw()+
  theme(
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown()
  )
```

**Figure S2.1**. Predispersal population size as a function of distance to the range edge (only populations up to 20 patches from the edge at the time of sampling included). The vertical line separate populations < 5 patches from the edge from the others.

<br/>

We can see that a threshold where we consider all patches < 5 patches from the edge as belonging to the range front is a good compromise that works across conditions. Narrower fronts would probably work for the high fecundity scenarios, but would not work for the low fecundity ones. In addition, a narrower threshold would limit the number of individuals included, reducing the precision of our trait means, while a wider one would lead us to fronts that are dominated by what are clearly non-front patches when fecundity is high.

# S3 - Checking velocity and evolutionary convergence

## Checking velocity convergence

If an expansion has converged to its asymptotic speed after a time $t$, then it means that its speed over the full duration of the simulation (if >$t$) and its speed over any interval after $t$ should be identical ($\pm$ stochastic noise, of course).

<br/>

```{r data-prep-convergence-speed}
speed_convergence <-data %>% 
  filter(ticks>1) %>%
  filter(N_postdispersal > 0) %>% 
  group_by(replicateID, fecundity, heritability, dispersal_mortality, ticks) %>%  
  summarise(edge_pxcor=max(pxcor)) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  mutate(persist=max(ticks)) %>% 
  ungroup() %>% 
  filter(persist==120) %>% # to be able to evaluate long-run speed we need to keep only these that persisted
  ## remove a few expansions for fecundity =1.5 only
  group_by(replicateID) %>% 
  arrange(ticks) %>% 
  mutate(prev_edge=lag(edge_pxcor)) %>% 
  mutate(prev_edge=replace_na(prev_edge,0)) %>% 
  mutate(speed_segment=(edge_pxcor-prev_edge)/20) %>% 
  mutate(overall_speed=subset(edge_pxcor,ticks==120)/120) %>% 
  ungroup()
```

```{r fig-s3-1, fig.width=9, fig.height=8}
speed_convergence %>% 
  filter(overall_speed>0) %>% #can't divide by overall speed if it is 0
  ggplot()+
    geom_hline(yintercept=1,lty=2)+
  geom_boxplot(aes(factor(ticks),speed_segment/overall_speed),
               col="grey40")+
  scale_y_continuous("ratio between velocity over interval and overall velocity")+
  scale_x_discrete("time interval (generations)",
                   labels=c("0-20","20-40","40-60","60-80","80-100","100-120"))+
  facet_grid(rows=vars(
                       paste("*r<sub>0</sub>* = log(",fecundity,")"),
                       paste("*m* =",dispersal_mortality)),
               cols=vars(paste("*h^2*=",heritability)))+
  theme_bw()+
  theme(
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(),
    legend.position = "none")+
  coord_cartesian(ylim=c(0,5))
##we cut outliers <0 (negative speeds over intervals) and >5 for clarity
```

**Figure S3.1**. Convergence of expansion velocity towards an equilibrium. Ratio of the velocity observed over a 20-generation interval and the velocity over the entire 120-generation run. y-axis is cut to [0-5] to better showcase the interquartile range.

<br/>

We find that convergence in expansion velocities is fast, and speeds measured at or after 100 generations can reasonably used as measures of long-run speed.

## Checking evolutionary convergence

We can then do a similar check for evolutionary stability at the edge. Because there is always some genetic variation remaining, let's use "only 5% of the initial genetic variation in traits remaining on average in front patches" as an arbitrary cutoff:

<br/>

```{r data-prep-convergence-evo}
evo_convergence <- data %>% 
  filter(heritability>0 & N_predispersal >0) %>% # doesn't make sense to test non-evolving replicates
  group_by(replicateID,ticks) %>% 
  mutate(edge_pxcor=max(pxcor)) %>% 
  ungroup() %>% 
  filter(pxcor>edge_pxcor-5) %>%  
  group_by(replicateID,ticks,heritability,
           is.VP_dmax,is.VP_DDD,
           VP_logit_dmax,VP_slope,VP_midpoint,
           dispersal_mortality,fecundity) %>%
  summarise(var_genotype_logit_dmax=weighted.mean(var_genotype_logit_dmax,N_predispersal,na.rm=TRUE),
            var_genotype_midpoint=weighted.mean(var_genotype_midpoint,N_predispersal,na.rm=TRUE),
            var_genotype_slope=weighted.mean(var_genotype_slope,N_predispersal,na.rm=TRUE)) %>% 
  ungroup() %>% 
  mutate(
    is.fixed_dmax=var_genotype_logit_dmax<(0.05*VP_logit_dmax),
    is.fixed_slope=var_genotype_slope<(0.05*VP_slope),
    is.fixed_midpoint=var_genotype_midpoint<(0.05*VP_midpoint)
  ) 

dmax_convergence <- evo_convergence %>% 
  filter(is.VP_dmax>0) %>% ## doesn't make sense to test it in replicates with no variation at the start
  group_by(ticks,fecundity,heritability,dispersal_mortality) %>% 
  summarise(prop_dmax=mean(is.fixed_dmax))

ddd_convergence <- evo_convergence %>% 
  filter(is.VP_DDD>0) %>% 
  group_by(ticks,fecundity,heritability,dispersal_mortality) %>% 
  summarise(prop_slope=mean(is.fixed_slope),
            prop_midpoint=mean(is.fixed_midpoint))
```

```{r fig-s3-2, fig.width=6, fig.height=8}

ggplot(ddd_convergence)+
  geom_line(aes(ticks,prop_midpoint),col="#1b9e77")+
  geom_line(aes(ticks,prop_slope),col="#d95f02")+
  geom_line(data=dmax_convergence,aes(ticks,prop_dmax),col="#7570b3")+
  scale_y_continuous("proportion of replicates with <5% of initial genetic variation remaining at the edge")+
  scale_x_continuous("generations")+
  facet_grid(rows=vars(
                       paste("*r<sub>0</sub>* = log(",fecundity,")"),
                       paste("*m* =",dispersal_mortality)),
               cols=vars(paste("*h^2*=",heritability)))+
  theme_bw()+
  theme(
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown())
```

**Figure S3.2**. Proportion of replicates that have "spent" their initial genetic variation, as a function of time. Within a panel, each line represents a different trait, with midpoint ($\beta$) in <span style="color: #1b9e77;">green</span>, slope ($\alpha$) in <span style="color: #d95f02;">orange</span> and $d_{max}$ in <span style="color: #7570b3;">blue</span> (the trajectories for all three traits are nearly identical).

<br/>

Using our operational definition of evolutionary "stability", we note that a very large majority of replicates have converged by the end of the experiment, especially in high fecundity replicates. In addition, we note that our definition of evolutionary stability excludes *de facto* cases of divergent selection, so the % of "evolutionary stable" expansions by $t$=100 generations, say, is possibly even higher.

# S4 - Results but for fecundity = 1.5


```{r import-by-fecundity}
tab_all <- read.csv(here("R_output", "processed_data_all_fecundities.csv"))

tab_low <- tab_all %>% 
  filter(fecundity==1.5)

tab_high<-tab_all %>%  #will be used in S5, might as well create it now
  filter(fecundity==5)
```

!!WAIT UNTIL THE EQUIVALENT CODE FOR MAIN ANALYSIS IS CLEAN AND THEN COPY IT
(with adjustments re: which is best model for 4.2 and 4.3)

<br/>

**Figure S4.1**. R^2^ of the different models used to analyse simulations outputs with respect to expansion velocity in the last 20 generations (left) and time to loss of neutral genetic diversity in the range front (right) (case where $r_{0}=\log(1.5)$, see **main text Fig. 2** for the case where $r_{0}=\log(5)$). Dashed line: R^2^for the "baseline" model containing only dispersal mortality (all models include dispersal mortality, and its interactions with the other covariates when present). 4.1 model selection

<br/>

<br/>

**Figure S4.2**. Predicted effect of $d_{0}$ (left) and density-dependence $\Delta_{avg-0}$ (right) on expansion velocity, depending of dispersal mortality (case where $r_{0}=\log(1.5)$, see **main text Fig. 3** for the case where $r_{0}=\log(5)$). Predictions are based on the best model **Fig. S4.1**; predictions for the effect of $d_{0}$ are made assuming no density-dependence ($\Delta_{avg-0}=0$), and predictions for the effect of $\Delta_{avg-0}$ are made setting $d_{0}$ to its average value in the simulated dataset. 

<br/>

<br/>

**Figure S4.3**. Predicted effect of $d_{0}$ (left) and density-dependence $\Delta_{avg-0}$ (right) on the loss of neutral diversity at the range front, depending of dispersal mortality (case where $r_{0}=\log(1.5)$, see **main text Fig. 4** for the case where $r_{0}=\log(5)$). Darker shades of grey indicate later fixation times. Predictions are based on the best model **Fig. S4.1**; predictions for the effect of $d_{0}$ are made assuming no density-dependence ($\Delta_{avg-0}=0$), and predictions for the effect of $\Delta_{avg-0}$ are made setting $d_{0}$ to its average value in the simulated dataset. 

<br/>

<br/>

**Figure S4.4**. Evolutionary changes in dispersal capacity $d_{max}$ at the range front as a function of sources of phenotypic variation and dispersal costs (case where $r_{0}=\log(1.5)$, see **main text Fig. 5** for the case where $r_{0}=\log(5)$). Grey dots are individual replicates, with the average values overlaid in black. Replicates with no individual variation in $d_{max}$ at $t=0$ are not displayed. 

<br/>

<br/>

**Figure S4.5**. Evolutionary changes in density-dependence $\Delta_{avg-0}$ at the range front as a function of its initial value, sources of phenotypic variation and dispersal costs (case where $r_{0}=\log(1.5)$, see **main text Fig. 6** for the case where $r_{0}=\log(5)$). Grey dots are individual replicates, with linear regression lines overlaid. Replicates with no individual variation in traits are not displayed. Grey-filled areas indicate impossible phenotypes, more specifically evolved values of $\Delta_{avg-0}$ that would imply dispersal rates higher than the maximal possible $d_{max}$ (1 if $d_{max}$ is variable among individuals, 0.5 if it is not). <!--IMPORTANT THOSE ARE AVERAGES, ADJUST NOTATIONS AND LEGEND FIG 5 AND 6-->

<br/>

# S5 - An unconditionality metric

A key prediction from <!--ref--> is that dispersal becomes more and more density-independent at range edges. That is, the dispersal-density function becomes flat over a wider and wider range of densities. However, we find (see main text) that density-dependence relevant to pushed vs pulled expansions still exists after evolution at the range edge. How to reconcile this?

It is relatively easy actually: the first step is to see that "flat over a larger and larger range of densities" does not mean "uniformly flat". As long as dispersal is slightly lower at specifically low densities, pushed dynamics can still happen, even if dispersal is fully independent of density over the rest of possible densities. The second step is to define an actual unconditionality index, and to test the prediction that, despite our results, our expansions still tend to become unconditional, on average. 

For a given emigration-density function $f(n)$ and a relevant range of densities $[0-K]$, we can define an unconditionality index $u$ as follows:

$u = \frac{\int_{0}^{K}f(n)\mathrm{d}n}{\max\limits_{0 \leq n \leq K} f(n)}$.

This index can take values between 0 and 1. The closer this index is to 1, the closer the average dispersal rate over the range 0-$K$ is equal to the maximal dispersal rate over the same range, i.e. the closer the dispersal function is to an horizontal line. For simplicity, as numerical integration from within base NetLogo is not possible, we approximated the numerator of $u$ by instead sampling $l$ density values at regular intervals over the range of densities and averaging the resulting dispersal rates:

$N = \{0, 0.1K, 0.2K,...,0.9K,K\}$,

$u_{[approx]} = \frac{(\sum_{n \in N}f(n))/l}{\max\limits_{n \in N} f(n)}$.

We can then easily see that evolution indeed leads dispersal to become more unconditional when fecundity is high (**Fig. S5.1**). 

<br/>

```{r fig-s5-1, fig.width=7, fig.height=12}
p11<- tab_high %>% 
  filter(is.VP_dmax==1 & is.VP_DDD==1) %>% 
  ggplot()+
    geom_point(aes(start_uncond,
                   mean_uncond_100-start_uncond),
               col="grey80")+
    geom_smooth(aes(start_uncond,
                    mean_uncond_100-start_uncond),
                method="lm",
                col="black",fill="#d95f02")+
  labs(title='C: Individual variation in *&alpha;*, *&beta;*, and *d<sub>max</sub>*')+
  scale_y_continuous("")+
  scale_x_continuous("Dispersal unconditionality index *u* at *t* = 0")

p10<- tab_high %>% 
  filter(is.VP_dmax==1 & is.VP_DDD==0) %>% 
  ggplot()+
    geom_point(aes(start_uncond,
                   mean_uncond_100-start_uncond),
               col="grey80")+
    geom_smooth(aes(start_uncond,
                    mean_uncond_100-start_uncond),
                method="lm",
                col="black",fill="#d95f02")+
 labs(title='B: Individual variation in *d<sub>max</sub>*')+
  scale_x_continuous("")+
  scale_y_continuous("Change in *u* at the edge between *t* = 0 et *t* = 100")

p01<- tab_high %>% 
  filter(is.VP_dmax==0 & is.VP_DDD==1) %>% 
  ggplot()+
    geom_point(aes(start_uncond,
                   mean_uncond_100-start_uncond),
               col="grey80")+
    geom_smooth(aes(start_uncond,
                    mean_uncond_100-start_uncond),
                method="lm",
                col="black",fill="#d95f02")+
  scale_y_continuous("")+
  scale_x_continuous("")+
  ggtitle("A: Individual variation in *&alpha;* and *&beta;*")

(p01/p10/p11) &
  coord_cartesian(ylim=c(-1,1),
                  xlim=c(0,1))&
  geom_hline(yintercept = 0,lty=2) &
  facet_grid(rows=vars(paste("*m* =",dispersal_mortality)),
               cols=vars(paste("*h^2* =",heritability))) &
  theme_bw()&
  theme(strip.text.x=element_markdown(),
        strip.text.y=element_markdown(),
        axis.title.x = element_markdown(),
        axis.title.y=element_markdown(),
        plot.title=element_markdown())

```

**Figure S5.1**. Evolutionary changes in dispersal unconditionality $u$ at the range front as a function of its initial value, sources of phenotypic variation and dispersal costs (case where $r_{0}=\log(5)$, see **Supplementary Figure S5.2** for the case where $r_{0}=\log(1.5)$). Grey dots are individual replicates, with linear regression lines overlaid. Replicates with no individual variation in traits are not displayed. 

<br/>

When fecundity is reduced, dispersal still becomes more unconditional with expansion, unless mortality costs are high (**Fig. S5.2**, below). Jointly with our main text result, this confirms that metrics specifically targeting differences to low-density behaviour are needed to understand pushed expansions.

<br/>

```{r fig-s5-2, fig.width=7, fig.height=12}
p11<- tab_low %>% 
  filter(is.VP_dmax==1 & is.VP_DDD==1) %>% 
  ggplot()+
    geom_point(aes(start_uncond,
                   mean_uncond_100-start_uncond),
               col="grey80")+
    geom_smooth(aes(start_uncond,
                    mean_uncond_100-start_uncond),
                method="lm",
                col="black",fill="#d95f02")+
  labs(title='C: Individual variation in *&alpha;*, *&beta;*, and *d<sub>max</sub>*')+
  scale_y_continuous("")+
  scale_x_continuous("Dispersal unconditionality index *u* at *t* = 0")

p10<- tab_low %>% 
  filter(is.VP_dmax==1 & is.VP_DDD==0) %>% 
  ggplot()+
    geom_point(aes(start_uncond,
                   mean_uncond_100-start_uncond),
               col="grey80")+
    geom_smooth(aes(start_uncond,
                    mean_uncond_100-start_uncond),
                method="lm",
                col="black",fill="#d95f02")+
 labs(title='B: Individual variation in *d<sub>max</sub>*')+
  scale_x_continuous("")+
  scale_y_continuous("Change in *u* at the edge between *t* = 0 et *t* = 100")

p01<- tab_low %>% 
  filter(is.VP_dmax==0 & is.VP_DDD==1) %>% 
  ggplot()+
    geom_point(aes(start_uncond,
                   mean_uncond_100-start_uncond),
               col="grey80")+
    geom_smooth(aes(start_uncond,
                    mean_uncond_100-start_uncond),
                method="lm",
                col="black",fill="#d95f02")+
  scale_y_continuous("")+
  scale_x_continuous("")+
  ggtitle("A: Individual variation in *&alpha;* and *&beta;*")

(p01/p10/p11) &
  coord_cartesian(ylim=c(-1,1),
                  xlim=c(0,1))&
  geom_hline(yintercept = 0,lty=2) &
  facet_grid(rows=vars(paste("*m* =",dispersal_mortality)),
               cols=vars(paste("*h^2* =",heritability))) &
  theme_bw()&
  theme(strip.text.x=element_markdown(),
        strip.text.y=element_markdown(),
        axis.title.x = element_markdown(),
        axis.title.y=element_markdown(),
        plot.title=element_markdown())

```

**Figure S5.2**. Evolutionary changes in dispersal unconditionality $u$ at the range front as a function of its initial value, sources of phenotypic variation and dispersal costs (case where $r_{0}=\log(1.5)$, see **Supplementary Figure S5.1** for the case where $r_{0}=\log(5)$). Grey dots are individual replicates, with linear regression lines overlaid. Replicates with no individual variation in traits are not displayed. 

<br/>

# References


