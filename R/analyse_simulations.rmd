---
title: 'Pushed expansions and sources of variation- individual-based model, data analysis'
author: "Maxime Dahirel & Chlo√© Guicharnaud"
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

```{r load-packages}
library(MASS)
library(arm)
library(matrixStats)
library(MuMIn)
library(tidyverse)
library(cowplot)
library(patchwork)


library(mgcv)
library(gratia)

library(here)
```

# Introduction

```{r}
raw_data <- read_csv(here("NetLogo_output","simulation_output.csv"))
```

We rewrite variance variables to be in 0/1 mode to not be distracted

```{r}
data<- raw_data  %>% 
  mutate(is.VP_dmax=as.numeric(VP_logit_dmax >0),
           is.VP_DDD=as.numeric(VP_slope >0))
```


# making sub data tables

a table with summary variables at the edge (we define edge as patch <5 patchs from tip, see suppl for justification)
```{r}
tab_edge<-data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor > front-5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    mean_dmax=weighted.mean(mean_dmax,N_predispersal,na.rm=TRUE),
    mean_d0=weighted.mean(mean_d0,N_predispersal,na.rm=TRUE),
    mean_avgslope=weighted.mean(mean_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_Kslope=weighted.mean(mean_slopeA_0_K,N_predispersal,na.rm=TRUE),
    mean_uncond=weighted.mean(mean_uncond_0_K,N_predispersal,na.rm=TRUE),
    front=mean(front)
  ) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD),
              names_from=ticks,
              values_from=c(mean_dmax,
                            mean_d0,mean_avgslope,mean_Kslope,mean_uncond,
                            front))
```


we also extract separately variables at t0
```{r}
tab_start<-data %>% select(
  start_dmax,
  start_d0,
  start_avgslope=start_slopeA_0_avg,
  start_Kslope=start_slopeA_0_K,
  start_uncond=start_uncond_0_K,
  replicateID
) %>% 
  distinct()

```

finally we run another extraction to get information on genetic diversity decay, time to fixation
(earliest observation of front (defined as above) only containing one of the two neutral alleles
)
```{r}
tab_genet <- data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor > front-5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    N_allele0=sum(N_allele0_post),
    N_allele1=sum(N_allele1_post)
  ) %>% 
  ungroup() %>% 
  mutate(edge_fix= N_allele0==0 | N_allele1==0) %>% 
  group_by(replicateID) %>% 
  mutate(time_to_fix=case_when(subset(edge_fix,ticks==20)==1 ~ 20,
                               subset(edge_fix,ticks==40)==1 ~ 40,
                               subset(edge_fix,ticks==60)==1 ~ 60,
                               subset(edge_fix,ticks==80)==1 ~ 80,
                               subset(edge_fix,ticks==100)==1 ~ 100,
                               subset(edge_fix,ticks==120)==1 ~ 120,
                               T~121)##not fixed yet at end of experiment
         ) %>% 
  ungroup() %>% 
  group_by(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(time_to_fix=unique(time_to_fix)) %>% 
  ungroup() %>% 
  mutate(fixinterval=ordered(time_to_fix,
                             levels=sort(unique(time_to_fix))
                             )
         )
```

now we can mix and combine these datasets for analyses

# analysis of speed and genetic dynamics


```{r}
tab <-tab_edge %>% 
  left_join(tab_start) %>% 
  left_join(tab_genet) %>% 
  mutate(mortality=factor(dispersal_mortality)) %>% 
  mutate(advance=front_120-front_100) 
```

for both velocity and genetics, we compare 4 models:

- one with and one without the density-dependency variable (is knowledge of DDD needed to predict?)
- both taken at g100 and at the start of the experiment (is knowledge of evolution needed?)

## velocity evidence

patches are discrete entities, and speed is capped at one patch/generation. So let's start with binomial models:


```{r}


tab2 <-tab %>% 
  mutate(d0_eff=(1-dispersal_mortality)*mean_d0_100,
         r0_eff=log(5-(dispersal_mortality*d0_eff)*5),
         vf=2*(log(5)*0.5*d0_eff)^0.5,
         vf2=2*(r0_eff*0.5*d0_eff)^0.5) %>% 
  arrange(d0_eff)

tab2 %>% 
  filter(mean_avgslope_100>-0.05 & mean_avgslope_100<0.05) %>% 
  ggplot()+ #only slope close to 0
  geom_point(aes(d0_eff, ##use effective d0, accounting for motality
                 advance/20,col=mortality))+
  geom_line(aes(d0_eff,vf2))+
  geom_line(aes(d0_eff,vf),lty=2)+
  facet_wrap(~dispersal_mortality)
## shows that the continuum approx for v is goodish until it bumps into the v=1 boundary
## birzu says approach is very good when r0<<0 and d0/r0 >>1
## we're not in these conditions but still good enough

## we won't use our models to try and disentangle effect of mortality on effective d0 versus
## other effects, but nice to know it exists
```



```{r}
mod_100=gam(cbind(advance,20-advance)~
              s(mean_d0_100,by=mortality)+
              s(mean_avgslope_100,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))
###does better than the nonlinear at d0=nearly 0 because d0 is an average
### even when d0=0, some individuals may not be at d0

mod_100_K=gam(cbind(advance,20-advance)~
              s(mean_d0_100,by=mortality)+
              s(mean_Kslope_100,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_100_noDDD=gam(cbind(advance,20-advance)~
              s(mean_d0_100,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))


mod_00=gam(cbind(advance,20-advance)~
              s(start_d0,by=mortality)+
              s(start_avgslope,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_00_K=gam(cbind(advance,20-advance)~
              s(start_d0,by=mortality)+
              s(start_Kslope,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_00_noDDD=gam(cbind(advance,20-advance)~
              s(start_d0,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_null=gam(cbind(advance,20-advance)~
              mortality, 
            family=binomial,data=subset(tab,advance>-1))
```

```{r}
gam_dev.expl=function(mod){
            return(summary(mod)$dev.expl)
}

gam_r2=function(mod){
            return(summary(mod)$r.sq)
          }


model.sel(list(mod_100=mod_100,
               mod_100_K=mod_100_K,
               mod_100_noDDD=mod_100_noDDD,
               mod_00=mod_00,
               mod_00_K=mod_00_K,
               mod_00_noDDD=mod_00_noDDD,
               mod_null=mod_null),extra=list(gam_dev.expl,gam_r2)) %>%  ##zero doubt the evol model is better
  rownames_to_column(var="model_name") %>% 
  as_tibble() %>% 
             mutate(is.evo=case_when(str_detect(model_name,"_100")~"after evolution (t = 100)",
                                     T~"before evolution (t = 0)"),
                    is.DDD=case_when(str_detect(model_name,"_noDDD")~"ignored",
                                     str_detect(model_name,"_K")~"included (shape-indep.)",
                                     T~"included (shape-dep.)")) %>% 
  filter(model_name!="mod_null") %>% 
  ggplot()+
  geom_point(aes(is.evo,AICc,
                         col=is.DDD),
                     size=3)+
  geom_line(aes(is.evo,AICc,
                group=is.DDD,
                col=is.DDD))+
  geom_hline(yintercept=AICc(mod_null),lty=2)+ ## the aicc of the mortality only model
  scale_x_discrete("when are trait covariables sampled?")+
  scale_y_continuous("AICc")+
  labs(col="Density dependence?")



draw(mod_100)
```



seems like data are underdispersed relative to the binomial, for all four models

```{r}
## function from ben bolker FAQ https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#overdispersion
overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

overdisp_fun(mod_100) ##the p value is for a test of overdispersion, not under look at the ratio
```



see comment from bob carpenter here: https://discourse.mc-stan.org/t/underdispersed-binomial-glm/1540
the idea that if underdispersed relative to binomial, then not the result of independent bernoulli trials
which make sense, since proba of advancing to N+1 depends on # of individuals that advanced to N
qualitative ccl are the same anyway though
an ordinal model may be appropriate instead
see eg https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#underdispersion
so let's go with that as a check (supplement?)

```{r}

library(cmdstanr)
library(brms)

tab_brm <- tab %>%
  mutate(scale_d0_100=scale(mean_d0_100)[,1], #standardisation only used for the brms check
         scale_d0_start=scale(start_d0)[,1],
         s_avgslope_100=mean_avgslope_100/sd(mean_avgslope_100),
         s_avgslope_start=start_avgslope/sd(start_avgslope),
         s_Kslope_100=mean_Kslope_100/sd(mean_Kslope_100),
         s_Kslope_start=start_Kslope/sd(start_Kslope))

prior<-c(
  set_prior("normal(0,1.5)",class="b")
)

mod_100_ordinal=brm(bf((advance+1)~ #because the first category must be 1
          (scale_d0_100+s_avgslope_100)*mortality),
        family=sratio,data=tab_brm,prior=prior,
        chains=4,seed=42,iter=2000,backend="cmdstanr")

## easy to expand to the otehr models
```

## genetic evidence

```{r}
mod_div_00=polr(fixinterval~
                     mortality+mortality:(start_d0+start_avgslope),
        data=filter(tab,front_120>0))#one front did not advance)    

mod_div_00_K=polr(fixinterval~
                     mortality+mortality:(start_d0+start_Kslope),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_00_noDDD=polr(fixinterval~
                     mortality+mortality:(start_d0),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_100=polr(fixinterval~
                     mortality+mortality:(mean_d0_100+mean_avgslope_100),
        data=filter(tab,front_120>0))#one front did not advance)    

mod_div_100_K=polr(fixinterval~
                     mortality+mortality:(mean_d0_100+mean_Kslope_100),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_100_noDDD=polr(fixinterval~
                     mortality+mortality:(mean_d0_100),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_null=polr(fixinterval~
                     mortality,
        data=filter(tab,front_120>0))#one front did not advance) 

```


```{r}

model.sel(list(mod_div_100=mod_div_100,
               mod_div_100_K=mod_div_100_K,
               mod_div_100_noDDD=mod_div_100_noDDD,
               mod_div_00=mod_div_00,
               mod_div_00_K=mod_div_00_K,
               mod_div_00_noDDD=mod_div_00_noDDD)) %>%  ##zero doubt the evol model is better
  rownames_to_column(var="model_name") %>% 
  as_tibble() %>% 
             mutate(is.evo=case_when(str_detect(model_name,"_100")~"after evolution (t = 100)",
                                     T~"before evolution (t = 0)"),
                    is.DDD=case_when(str_detect(model_name,"_noDDD")~"ignored",
                                     str_detect(model_name,"_K")~"included (shape-indep.)",
                                     T~"included (shape-dep.)")) %>% 
  ggplot()+
  geom_point(aes(is.evo,AICc,
                         col=is.DDD),
                     size=3)+
  geom_line(aes(is.evo,AICc,
                group=is.DDD,
                col=is.DDD))+
  geom_hline(yintercept=AICc(mod_div_null),lty=2)+ ## the aicc of the mortality only model
  scale_x_discrete("when are trait covariables sampled?")+
  scale_y_continuous("AICc")+
  labs(col="Density dependence?")


```

# analyse evolution

our main tool: the plot y-x~x where y=trait after evol, x=trait at t0, deviation from nthe line y-x=0 indicate evolution


```{r}

tab$test_davg=tab$mean_d0_100+tab$mean_avgslope_100
tab$test_start_davg=tab$start_d0+tab$start_avgslope

p11<- tab %>% 
  filter(is.VP_dmax==1 & is.VP_DDD==1) %>% 
  ggplot()+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=1-x,ymax=1),
                fill="darkgrey",col="black",alpha=0.5)+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=-1-x,ymax=-1),
                fill="darkgrey",col="black",alpha=0.5)+
  # denotes the strategies possibles (davg>dmax not possible)
    geom_point(aes(start_avgslope,
                   mean_avgslope_100-start_avgslope),alpha=0.1)+
    geom_smooth(aes(start_avgslope,
                    mean_avgslope_100-start_avgslope),method="lm",col="red")+
  ggtitle('D: Individual variation in slope and dmax')

p10<- tab %>% 
  filter(is.VP_dmax==1 & is.VP_DDD==0) %>% 
  ggplot()+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=1-x,ymax=1),
                fill="darkgrey",col="black",alpha=0.5)+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=-1-x,ymax=-1),
                fill="darkgrey",col="black",alpha=0.5)+
  # denotes the strategies possibles (davg>dmax not possible)
    geom_point(aes(start_avgslope,
                   mean_avgslope_100-start_avgslope),alpha=0.1)+
    geom_smooth(aes(start_avgslope,
                    mean_avgslope_100-start_avgslope),method="lm",col="red")+
  ggtitle('C: Individual variation in dmax')
#the white area delimitate the maximal space available for evolution (slope or davg after avolution cannot go higher than abs(maximal dmax possible under the variance conditions))
#note that no var vignettes should probably be all grey (no evolution possible)

p01<- tab %>% 
  filter(is.VP_dmax==0 & is.VP_DDD==1) %>% 
  ggplot()+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=0.5-x,ymax=1),
                fill="darkgrey",col="black",alpha=0.5)+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=-0.5-x,ymax=-1),
                fill="darkgrey",col="black",alpha=0.5)+
  # denotes the strategies possibles (davg>dmax not possible)
    geom_point(aes(start_avgslope,
                   mean_avgslope_100-start_avgslope),alpha=0.1)+
    geom_smooth(aes(start_avgslope,
                    mean_avgslope_100-start_avgslope),method="lm",col="red")+
  ggtitle('B: Individual variation in slope')

p00<- tab %>% 
  filter(is.VP_dmax==0 & is.VP_DDD==0) %>% 
  ggplot()+
    geom_ribbon(data=tibble(x=c(-100:100)/100),
                aes(x=x,ymin=-1,ymax=1),
                fill="darkgrey",alpha=0.5)+
  # denotes the strategies possibles (davg>dmax not possible)
    geom_point(aes(start_avgslope,
                   mean_avgslope_100-start_avgslope),alpha=0.1)+
    geom_smooth(aes(start_avgslope,
                    mean_avgslope_100-start_avgslope),method="lm",col="red")+
  ggtitle('A: No individual variation') 

result<- ((p00|p01)/(p10+p11)) &
  geom_hline(yintercept = 0,lty=2) &
  scale_x_continuous("") &
  scale_y_continuous("") &
  coord_cartesian(xlim=c(-0.3,0.3),ylim=c(-0.25,0.8))  & 
  facet_grid(rows=vars(paste("m =",dispersal_mortality)),
               cols=vars(paste("h2 =",heritability))) &
  theme_bw()

gt <- patchwork::patchworkGrob(result)
gridExtra::grid.arrange(gt, 
                        left = "Change in density-dependence at the expanding edge between t = 0 et t = 100", 
                        bottom = "Density-dependence at t = 0")





tab %>% 
  ggplot()+
    geom_ribbon(data=ribboning,
                aes(x=x,ymin=0.5+0.5*(is.VP_dmax==1)-1*x,ymax=1),
                fill="darkgrey",alpha=0.5)+
      geom_ribbon(data=ribboning,
                aes(x=x,ymax=-0.5-0.5*(is.VP_dmax==1)-1*x,ymin=-1),
                fill="darkgrey",alpha=0.5)+
    geom_hline(yintercept = 0,lty=2)+
    geom_abline(aes(intercept=0.5+0.5*(is.VP_dmax==1),slope=-1))+
    geom_abline(aes(intercept=-0.5-0.5*(is.VP_dmax==1),slope=-1))+
  # denotes the strategies possibles (davg>dmax not possible)
    geom_point(aes(test_start_davg,
                                 test_davg-test_start_davg),alpha=0.1)+
    geom_smooth(aes(test_start_davg,
                                 test_davg-test_start_davg),method="lm")+
    facet_grid(rows=vars(dispersal_mortality,paste("Vdmax",is.VP_dmax)),
               cols=vars(heritability,paste("Vddd",is.VP_DDD)))+
  theme_bw()+
  scale_x_continuous("starting average dispersal")+
  scale_y_continuous("change in average dispersal during evolution")+
  coord_cartesian(xlim=c(0,0.5),ylim=c(-0.5,0.8))

tab %>% 
  ggplot()+
    geom_hline(yintercept = 0,lty=2)+
    geom_jitter(aes(0,
                                 mean_dmax_100-start_dmax),alpha=0.3,col="grey")+
    facet_grid(rows=vars(dispersal_mortality,paste("Vdmax",is.VP_dmax)),
               cols=vars(heritability,paste("Vddd",is.VP_DDD)))+
  theme_bw()
```


```{r fig 1}

tt=tibble(x=c(0:120)/100) %>% 
  expand_grid(dmax=c(0.2,0.5,0.7),
              a=c(-10,0,10),
              b=c(0.2,0.5,1.1)) %>% 
  mutate(group=paste(dmax,a,b)) %>% 
  mutate(d=dmax/(1+exp(-a*(x-b))))

p_dmax <- tt %>% 
  filter(b==0.5 & a==10)%>% 
  ggplot()+
  geom_line(aes(x,d,group=group))+
  geom_textbox(data=tibble(dmax=unique(tt$dmax)),
                 aes(x=1,
                 y=dmax-0.05,
                 label=paste("*d<sub>max</sub>* = ",dmax)),
               width = grid::unit(0.3, "npc")
                 )+
  scale_x_continuous("N/K")+
  scale_y_continuous("Dispersal probability")+
  theme_bw()

p_alpha <- tt %>% 
  filter(b==0.5 & dmax==0.7)%>% 
  ggplot()+
  geom_line(aes(x,d,group=group))+
  geom_textbox(data=tibble(b=0.5,
                           dmax=0.7,
                           a=unique(tt$a)),
               aes(x=1,
                 y=dmax/(1+exp(-a*(1-b))),
                 label=paste("*&alpha;* =",a)),
               width = grid::unit(0.22, "npc"))+
  scale_x_continuous("N/K")+
  scale_y_continuous("")+
  theme_bw()

p_beta <- tt %>% 
  filter(a==10 & dmax==0.7)%>% 
  ggplot()+
  geom_line(aes(x,d,group=group))+
  geom_textbox(data=tibble(b=unique(tt$b),
                           dmax=0.7,
                           a=10),
               aes(x=b,
                 y=0.4,
                 label=paste("*&beta;* =",b)),
               width = grid::unit(0.15, "npc"))+
  scale_x_continuous("N/K")+
  scale_y_continuous("")+
  theme_bw()


tt2=tibble(dmax=c(0.734,0.8),
              a=c(20,6),
              b=c(0.2,0.6)) %>%
  expand_grid(x=rep(c(0:10)/10,2)) %>% 
  mutate(d=dmax/(1+exp(-a*(x-b))))


p1<-tt2 %>% 
  ggplot(aes(x=x,y=d))+
  geom_line(aes(col=factor(dmax)))+
  geom_point(aes(col=factor(dmax),shape=factor(dmax)),size=5,fill="white")+
  scale_x_continuous("N/K")+
  scale_y_continuous("Dispersal probability")+
  scale_shape_discrete()+
  theme_bw()

p2<-tt2 %>% 
  group_by(dmax) %>% 
  summarise(d0=subset(d,x==0),
            dK=subset(d,x==1),
            davg=mean(d)) %>% 
  pivot_longer(cols=c(d0,dK,davg)) %>% 
  mutate(name=fct_recode(name,
                         `*d<sub>0</sub>*`="d0",
                         `*d<sub>avg</sub>*`="davg",
                         `*d<sub>K</sub>*`="dK")) %>% 
  ggplot()+
  geom_point(aes(name,value,col=factor(dmax),shape=factor(dmax)),
             size=5,fill="white",position=position_dodge(width=0.4))+
  scale_x_discrete("dispersal variable")+
  scale_y_continuous("value")+
  scale_shape_discrete()+
  theme_bw()+
  theme(axis.text.x = element_markdown())

(p_dmax|p_alpha|p_beta)/(p1+p2)&
  theme(legend.position = "none")

```

