---
title: 'main analysis code for "Individual variation in dispersal, and its sources, shape the fate of pushed vs. pulled range expansions"'
author: "Maxime Dahirel, Chlo√© Guicharnaud, Elodie Vercken (code by Maxime Dahirel)"
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

```{r load-packages}
library(tidyverse)

library(brms)
library(bayesplot)
library(tidybayes)
options(mc.cores=4)

library(patchwork)   # CRAN v1.1.1
library(ggtext)

library(here)        # CRAN v1.0.1
```

# Introduction

After running the code in `R/generate_simulations`, we obtained, and saved, a `csv` file containing patch-level data for every simulation we ran. We can now load it, but we're going to immediately make a quick change: in the IBM, phenotypic variance input variables denote, well, the actual phenotypic variances we wanted to input. But since we only tested two levels, variance or no variance, much easier for us to work with binary variables going forward:

```{r import-data}
data <- read_csv(here("NetLogo_output", "simulation_output.csv")) %>%
  mutate(
    is.VP_dmax = as.numeric(VP_logit_dmax > 0),
    is.VP_DDD = as.numeric(VP_slope > 0)
    # if VP_slope >0, then VP_midpoint is also >0 in our experimental design
    # so only one binary variable needed for density-dependent dispersal variables
  )
```

OK, the dataset we just imported is structured so that one row = one patch in one landscape at one observed time. Only patches that were populated at least once are included (see the end of the `generate_simulations` file). The dataset contains many variables, many of them were collected as a precaution "in case they were needed later" (since re-running the models is time consuming); not all of them will be used in the analysis:

- `ticks`: time step at which the observations were made (= number of generations since start), we planned to collect data only at the end of the runs (`ticks` = 120). As `nlrx` may fail if no data are collected for a run, we also collected data at `ticks` = 1, to avoid issues with replicates that go extinct before the end of their run.

Landscape-level variables, all constant across time (either because they are truly constant, or because they only describe initial conditions at $t=0$ and are not updated after):
              
- `start_dmax`, `start_slope`, `start_midpoint`: mean dispersal trait values at the start of the experiment (`slope` corresponds to $\alpha$ in the manuscript, `midpoint` to $\beta$)
- `VP_logit_dmax`, `VP_slope`, `VP_midpoint`: **initial** phenotypic variances
- `is.VP_dmax`, `is.VP_DDD`: binary variables describing whether `VP_logit_dmax` on one hand, and `VP_slope` and `VP_midpoint` on the other, are >0
- `heritability`: **initial** heritability (same value for all traits)
- `dispersal_mortality`: probability of dying during dispersal
- `fecundity`: hypothetical average fecundity at $N=0$ ($\exp(r_{0})$)               
- `K`: patch carrying capacity (same for all patches)
- `reproduction`: whether the simulated species was clonal or sexual (here all runs are clonal)
- `seedID`, `siminputrow`, `replicateID`: the first two variables, combined, give the third one: a unique identifier for each landscape/run
- `start_d0`, `start_dK`, `start_davg_0_K`, `start_slopeA_0_K`, `start_slopeA_0_avg`: mean values for $d_{0}$, $d_{K}$, $d_{avg}$,  the density-dependence metrics $\Delta_{K-0}$, $\Delta_{avg-0}$ in the starter population (see <!--SUPPLEMENTARY TO ADD--> for the definition of each of these variables)        
- `start_uncond_0_K`: same as above, for the unconditionality metric (see <!--supplementary to add/edit?--> for the definition of that metric)


Patch-level variables:
- `pxcor`: patch $x$ coordinate                   
- `founding`: the generation at which the patch was first populated
- `N_predispersal` and `N_postdispersal`: population size in the patch immediately before and after the dispersal phase, respectively
- `N_sedentary`: number of individuals born in the patch that stayed in it
- `N_disp_dead`: number of individuals born in the patch that died during dispersal             
- `N_allele0_pre`, `N_allele1_pre`, `N_allele0_post`, `N_allele1_post`: number of individuals with each neutral allele, pre- and post-dispersal
- `mean_genotype_logit_dmax`, `var_genotype_logit_dmax`, `mean_genotype_slope`, `var_genotype_slope`, `mean_genotype_midpoint`,  `var_genotype_midpoint`: mean and variances  of the genetic component of traits   
- `mean_dmax`, `mean_slope`, `mean_midpoint`: phenotypic means of the dispersal traits
- `mean_d0`, `mean_dK`, `mean_davg_0_K`, `mean_slopeA_0_K`, `mean_slopeA_0_avg`, `mean_uncond_0_K`: means of dispersal metrics that can be estimated from these dispersal traits (see above)     

# Data wrangling

To do our analyses, we're going to build several "processed" tables from this "raw" dataset, which we'll then merge into a final table.

Again: we will only focus on the state of our expansions at the end of the simulations (t = 120). There is good evidence that evolutionary dynamics are at or close to equilibrium for most replicates at this time. <!--DISCUSS IN SUPPLEMENTARY-->

Second: we will consistently use the metrics as captured at the *start* of each generation, i.e. pre-dispersal. This is to avoid trying to interpret non-genetic dynamics in traits that are reset each generation. For instance, if dispersal capacity is variable but 100% non-genetic, there may be an excess of high dispersers in newly colonised patches. This excess will however vanish when they reproduce and dispersal traits are redrawn. In front patches that are funded by a low number of individuals, this also allows us to estimate patch averages for traits and genetic diversity from higher post-reproduction numbers vs. lower founding numbers.

We start by creating a dataset for genetic diversity, with one observation = one replicate expansion. Our metric of genetic diversity is spatial, and based on the positions of the expansion front for the whole expansion vs. for the individuals that bear the neutral allele that lags behind. In addition to this information, we create a `scenario` variable that groups together all replicates that share the same initial conditions (fecundity, mortality, starting values of dispersal traits, their variability and heritability).

```{r}
tab <- data  |>
  filter(ticks==120) |> # we only keep the last iteration
  filter(N_predispersal>0) |> # for genetic diversity to be measured in a patch, there needs to be individuals
  mutate(scenario=paste0("F=",fecundity, "_M=",dispersal_mortality,
                         "_h2=",heritability,
                     "_slope=",start_slope,"_midpoint=",start_midpoint,
                     "_VP.DDD=",is.VP_DDD,"_VP_dmax=",is.VP_dmax)) |> 
  group_by(replicateID, scenario, ticks, 
           dispersal_mortality, heritability, fecundity,
           is.VP_dmax, is.VP_DDD,
           start_slope, start_midpoint,
           start_d0, start_dK,        
           start_slopeA_0_K) |> 
  summarise(edge1 = max(pxcor * (N_allele1_pre > 0), na.rm=TRUE), # the coordinate of the farthest individual with neutral allele 1
            edge0 = max(pxcor * (N_allele0_pre > 0), na.rm=TRUE)  # same with neutral allele 0
  ) |> 
  rowwise() |> 
  mutate(edge_pre = max(edge0, edge1),  # which is the farthest of the two irrespective of allele value
         lagging_pre = min(edge0, edge1) # which is the other?
  ) |> 
  ungroup()
```

```{r}
tab_edge <- data  |>
  filter(ticks==120) |> # we only keep the last iteration
  filter(N_postdispersal>0) |> 
  group_by(replicateID) |> 
  summarise(edge_post = max(pxcor, na.rm=TRUE)) |> 
  ungroup()
```

```{r}
tab <- left_join(tab, tab_edge)
```


We then create a dataset that contain the mean dispersal trait values at time $t$ in the range front (which we defined here semi-arbitrarily as patches < 5 patches from the edge; see <!--Supplementary S2--> for justification).

We first use the previously created dataset to know, for each replicate, which patches are "front patches" (we use the edge pre-dispersal as a reference, since traits are measured pre-dispersal)

```{r}
tab_intermediate <- tab |> 
  select(replicateID, edge_pre)

```

We then use that to (i) filter the big `data` to only keep front patches (ii) and then get weighted averages for each key trait 


```{r}
tab_traits <- data |> 
  filter(ticks==120) |> 
  left_join(tab_intermediate) |> 
  filter(pxcor > (edge_pre - 5)) |> 
  group_by(replicateID, ticks)  |> 
  summarise(
    mean_dmax = weighted.mean(mean_dmax, w = N_predispersal, na.rm = TRUE),
    mean_dK = weighted.mean(mean_dK, w = N_predispersal, na.rm = TRUE),
    mean_d0 = weighted.mean(mean_d0, w = N_predispersal, na.rm = TRUE),
    mean_Kslope = weighted.mean(mean_slopeA_0_K, w = N_predispersal, na.rm = TRUE)
  )  |> 
  ungroup()
```

We can then merge the two in one dataset, and we rename some variables so that models are a bit easier to write below

```{r}
tab <- left_join(tab,tab_traits) |> 
  mutate(Mort=factor(dispersal_mortality),
         Fec=factor(fecundity)
         ) |> 
  rename(start_Kslope="start_slopeA_0_K")
```

```{r}
N_replicates<-length(unique(data$replicateID))
N_non_extinct<-length(unique(tab$replicateID)) 
```


```{r}
tab <- filter(tab, edge_pre>0) # we exclude what did not advance
```

```{r}

N_expand<-length(unique(tab$replicateID)) 
```


# Analysis

We can't really combine in one analysis all the simulations: (i) expansions without phenotypic variation, (ii) with only non-heritable phenotypic variation and (iii) where evolution is possible in at least one trait are three "regimes" that are best analysed separately.

So let's split the data:

```{r}

tab_fix = filter(tab, is.VP_DDD ==0 & is.VP_dmax ==0) #(i) traits are fixed

tab_noevo = filter(tab,(is.VP_DDD==1 | is.VP_dmax==1) & heritability ==0) #(ii) traits can vary but do not evolve
tab_evo = filter(tab,(is.VP_DDD==1 | is.VP_dmax==1) & heritability == 1) #(iii) at least one trait can evolve

dim(tab)[1] == (dim(tab_fix)[1] + dim(tab_noevo) [1] + dim(tab_evo)[1]) #sense check

```

For (i) and (ii) there is no reason to analyse phenotypic trait changes, this can only be done meaningfully in (iii) (and even in iii, not all trait changes can be analysed for all replicates, as we'll see later)

## Priors

```{r}
prior_binomial <- c(
                    set_prior("normal(0,1.5)",class="Intercept"),
                    set_prior("normal(0,1)",class="b"),
                    set_prior("normal(0,1)",class="sd")
                  )

prior_beta_binomial <- c(
                    set_prior("normal(0,1.5)",class="Intercept"),
                    set_prior("normal(0,1)",class="b"),
                    set_prior("normal(0,1)",class="sd"),
                    set_prior("normal(0,1)",nlpar="loginvphi",class="b")
                  )

prior_beta <- prior_beta_binomial
```



## Genetic diversity models

```{r}
mod_gen_fixB <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + 
                          (1|scenario)),
                  family=binomial,
                  data=tab_fix,backend="cmdstanr",
        seed=42,
                  prior= prior_binomial
)

pp_check(mod_gen_fixB,"stat_2d") #some evidence of overdispersion?

mod_gen_fixBB0 <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + (1|scenario),
                         nlf(phi~1/exp(loginvphi)),
                         # the "default" overdispersion parameter in brms is actually a precision parameter
                         # the closest to Inf the closest to binomial
                         # we want an overdispersion parameter (as in Harrison 2015), so we inverse
                         loginvphi~1),
                  family=beta_binomial(link_phi="identity"), # we need identity link so the transform works well
                  data=tab_fix,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_fixBB0,"stat_2d") # better

mod_gen_fixBB <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ start_Kslope * Mort * Fec  + (1|scenario)),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_fix,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_fixBB,"stat_2d") # good

loo_compare(
  loo(mod_gen_fixB),
  loo(mod_gen_fixBB0),
  loo(mod_gen_fixBB)
)
## even with a few "Pareto k problematic obs", the differences in loo and the pp_check are clear
```


```{r}
select(tab_fix,Mort,Fec,scenario) |> distinct() |> group_by(Mort,Fec) |> count() 
#210 scenarios possible, so in theory 5*210 replicates = 1050
#7 scenarios went fully extinct/failed to advance, so 203, and a max of 1015 replicates
# we have 1009, so some scenarios failed elsewhere
```

```{r}
fits_fix=select(tab_fix,Mort,Fec) |> distinct() |> 
  mutate(edge_pre=1) |> 
  expand_grid(start_Kslope=c(-5:5)/10) |> 
  add_epred_draws(mod_gen_fixBB,re_formula=NA) |> 
  ungroup()

tab_fix |>  
  ggplot()+
  geom_point(aes(x=start_Kslope,y=lagging_pre/edge_pre,size=edge_pre),col="lightblue",alpha=0.25)+
  stat_lineribbon(data=fits_fix,aes(x=start_Kslope,y=.epred),fill="grey",col="grey40")+
  geom_point(data=tab_fix |> group_by(scenario,Mort,Fec) |> 
               summarise(div=mean(lagging_pre/edge_pre,na.rm=TRUE),
                         slope=mean(start_Kslope)),
             aes(x=slope,div),size=2,fill="white",pch=21)+
  facet_grid(rows=vars(paste0("*r<sub>0</sub>* = log(",Fec,")")),cols=vars(paste("*m* =",Mort)))+
  scale_x_continuous("initial dispersal density-dependence (*&Delta;<sub>K-0</sub>*)")+
  scale_y_continuous("how far does genetic diversity persist?")+
  ggtitle(label="",
          subtitle="A) replicates with no individual variation in dispersal traits")+
  theme_bw()+
  theme(legend.position = "none",
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(angle = 0),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    plot.subtitle = element_markdown()
  )
```

```{r}
mod_gen_noevoB <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + 
                          (1|scenario)),
                  family=binomial,
                  data=tab_noevo,backend="cmdstanr",
                  seed=42,
                  prior=prior_binomial
)

pp_check(mod_gen_noevoB,"stat_2d")

mod_gen_noevoBB0 <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + 
                          (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ 1),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_noevo,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_noevoBB0,"stat_2d")

mod_gen_noevoBB <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ start_Kslope * Mort * Fec  + (1|scenario)),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_noevo,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_noevoBB,"stat_2d") # good

loo_compare(
  loo(mod_gen_noevoB),
  loo(mod_gen_noevoBB0),
  loo(mod_gen_noevoBB)
)
```


```{r}
select(tab_noevo,Mort,Fec,scenario) |> distinct() |> group_by(Mort,Fec) |> count() 
#630 scenarios possible, so in theory 5*630 replicates = 3050
#9 scenarios went fully extinct/failed to advance (again all at max mortality low fec), so 621, and a max of 3105 replicates
# we have 3092, so some scenarios failed elsewhere
```

```{r}
fits_noevo=select(tab_noevo,Mort,Fec) |> distinct() |> 
  mutate(edge_pre=1) |> 
  expand_grid(start_Kslope=c(-5:5)/10) |> 
  add_epred_draws(mod_gen_noevoBB,re_formula=NA) |> 
  ungroup()

outline_fix = fits_fix |> 
  ungroup() |> 
  group_by(Mort,Fec, start_Kslope) |> 
  mean_hdci(.epred) |> 
  ungroup()

tab_noevo |>  
  ggplot()+
  geom_point(aes(x=start_Kslope,y=lagging_pre/edge_pre,size=edge_pre),col="pink",alpha=0.25)+
  stat_lineribbon(data=fits_noevo,aes(x=start_Kslope,y=.epred),fill="grey",col="grey40")+
  geom_line(data=outline_fix,aes(x=start_Kslope,y=.lower),lty=2)+
  geom_line(data=outline_fix,aes(x=start_Kslope,y=.upper),lty=2)+
  geom_point(data=tab_noevo |> group_by(scenario,Mort,Fec) |> 
               summarise(div=mean(lagging_pre/edge_pre,na.rm=TRUE),
                         slope=mean(start_Kslope)),
             aes(x=slope,div),size=2,fill="white",pch=21)+
  facet_grid(rows=vars(paste0("*r<sub>0</sub>* = log(",Fec,")")),cols=vars(paste("*m* =",Mort)))+
  scale_x_continuous("initial dispersal density-dependence (*&Delta;<sub>K-0</sub>*)")+
  scale_y_continuous("how far does genetic diversity persist?")+
  ggtitle(label="",
          subtitle="B) individual variation in dispersal traits but no evolution (*h<sup>2</sup>* = 0)")+
  theme_bw()+
  theme(legend.position = "none",
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(angle = 0),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    plot.subtitle = element_markdown()
  )
```


```{r}
mod_gen_evoB <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + 
                          (1|scenario)),
                  family=binomial,
                  data=tab_evo,backend="cmdstanr",
                  seed=42,
                  prior=prior_binomial
)

pp_check(mod_gen_evoB,"stat_2d")

mod_gen_evoBB0 <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + 
                          (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ 1),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_evo,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_evoBB0,"stat_2d")

mod_gen_evoBB <- brm(bf(lagging_pre|trials(edge_pre)~ start_Kslope * Mort * Fec  + (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ start_Kslope * Mort * Fec  + (1|scenario)),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_evo,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_evoBB,"stat_2d") # good

loo_compare(
  loo(mod_gen_evoB),
  loo(mod_gen_evoBB0),
  loo(mod_gen_evoBB)
)
```


```{r}
fits_evo=select(tab_noevo,Mort,Fec) |> distinct() |> 
  mutate(edge_pre=1) |> 
  expand_grid(start_Kslope=c(-5:5)/10) |> 
  add_epred_draws(mod_gen_evoBB,re_formula=NA)

outline_noevo = fits_noevo |> 
  ungroup() |> 
  group_by(Mort,Fec, start_Kslope) |> 
  mean_hdci(.epred) |> 
  arrange(start_Kslope) |> 
  ungroup()

tab_evo |>  
  ggplot()+
  geom_point(aes(x=start_Kslope,y=lagging_pre/edge_pre,size=edge_pre),col="palegreen",alpha=0.25)+
  stat_lineribbon(data=fits_evo,aes(x=start_Kslope,y=.epred),fill="grey",col="grey40")+
  geom_line(data=outline_noevo,aes(x=start_Kslope,y=.lower),lty=2)+
  geom_line(data=outline_noevo,aes(x=start_Kslope,y=.upper),lty=2)+
  geom_point(data=tab_evo |> group_by(scenario,Mort,Fec) |> 
               summarise(div=mean(lagging_pre/edge_pre,na.rm=TRUE),
                         slope=mean(start_Kslope)),
             aes(x=slope,div),size=2,fill="white",pch=21)+
  facet_grid(rows=vars(paste0("*r<sub>0</sub>* = log(",Fec,")")),cols=vars(paste("*m* =",Mort)))+
  scale_x_continuous("initial dispersal density-dependence (*&Delta;<sub>K-0</sub>*)")+
  scale_y_continuous("how far does genetic diversity persist?")+
  ggtitle(label="",
          subtitle="C) individual variation in dispersal traits *and* evolution possible (*h<sup>2</sup>* = 1)")+
  theme_bw()+
  theme(legend.position = "none",
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(angle = 0),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    plot.subtitle = element_markdown()
  )
```

Evo, but using traits post evo:

```{r}
mod_gen_postevoB <- brm(bf(lagging_pre|trials(edge_pre)~ mean_Kslope * Mort * Fec  + 
                          (1|scenario)),
                  family=binomial,
                  data=tab_evo,backend="cmdstanr",
                  seed=42,
                  prior=prior_binomial
)

pp_check(mod_gen_postevoB,"stat_2d")

mod_gen_postevoBB0 <- brm(bf(lagging_pre|trials(edge_pre)~ mean_Kslope * Mort * Fec  + 
                          (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ 1),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_evo,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_postevoBB0,"stat_2d")

mod_gen_postevoBB <- brm(bf(lagging_pre|trials(edge_pre)~ mean_Kslope * Mort * Fec  + (1|scenario),
                        nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ mean_Kslope * Mort * Fec  + (1|scenario)),
                  family=beta_binomial(link_phi="identity"),
                  data=tab_evo,backend="cmdstanr",
                  seed=42,
                  prior=prior_beta_binomial
)

pp_check(mod_gen_postevoBB,"stat_2d") # good

loo_compare(
  loo(mod_gen_postevoB),
  loo(mod_gen_postevoBB0),
  loo(mod_gen_postevoBB)
)
```


```{r}
fits_postevo=select(tab_evo,Mort,Fec) |> distinct() |> 
  mutate(edge_pre=1) |> 
  expand_grid(mean_Kslope=c(-10:10)/10) |> 
  add_epred_draws(mod_gen_postevoBB,re_formula=NA)

outline_evo = fits_evo |> 
  ungroup() |> 
  group_by(Mort,Fec, start_Kslope) |> 
  mean_hdci(.epred) |> 
  arrange(start_Kslope) |> 
  ungroup()

tab_evo |>  
  ggplot()+
  geom_point(aes(x=mean_Kslope,y=lagging_pre/edge_pre,size=edge_pre),col="palegreen",alpha=0.25)+
  stat_lineribbon(data=fits_postevo,aes(x=mean_Kslope,y=.epred),fill="grey",col="grey40")+
  #geom_line(data=outline_evo,aes(x=start_Kslope,y=.lower),lty=2)+
  #geom_line(data=outline_evo,aes(x=start_Kslope,y=.upper),lty=2)+
  geom_point(data=tab_evo |> group_by(scenario,Mort,Fec) |> 
               summarise(div=mean(lagging_pre/edge_pre,na.rm=TRUE),
                         slope=mean(mean_Kslope)),
             aes(x=slope,div),size=2,fill="white",pch=21)+
  facet_grid(rows=vars(paste0("*r<sub>0</sub>* = log(",Fec,")")),cols=vars(paste("*m* =",Mort)))+
  scale_x_continuous("**final** dispersal density-dependence (*&Delta;<sub>K-0</sub>*)")+
  scale_y_continuous("how far does genetic diversity persist?")+
  ggtitle(label="",
          subtitle="C) individual variation in dispersal traits *and* evolution possible (*h<sup>2</sup>* = 1)")+
  theme_bw()+
  theme(legend.position = "none",
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(angle = 0),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    plot.subtitle = element_markdown()
  )
```




## evo models : slope

```{r}
tab_evo_DDD <- filter(tab_evo, is.VP_DDD==1) |>
  mutate(mean_Kslope_std = mean_Kslope/mean_dmax)
  


mod_slope <- brm(bf((mean_Kslope_std/2)+0.5~ start_Kslope * Mort * Fec  + (1|scenario),
                    nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ start_Kslope * Mort * Fec  + (1|scenario)),
                  family=Beta(link_phi="identity"),
                  data=tab_evo_DDD,backend="cmdstanr",
                 seed=42,
                  prior=prior_beta
)
```

```{r}
fits_slope=select(tab_evo_DDD,Mort,Fec) |> distinct() |> 
  expand_grid(start_Kslope=c(-5:5)/20) |> 
  add_epred_draws(mod_slope,re_formula=NA) |> 
  mutate(.epred = (.epred - 0.5) * 2) # rescaling to the -dmax/+dmax range

tab_evo_DDD |>  
  ggplot()+
  geom_abline(intercept = 0,slope=2,lty=2)+ 
  # ^ relative slope = absolute_slope / dmax  = absolute_slope / 0.5 at t=0
  # y = x/0.5 is y = x*2
  geom_point(aes(x=start_Kslope,y=mean_Kslope/mean_dmax),col="palegreen",alpha=0.25)+
  stat_lineribbon(data=fits_slope,aes(x=start_Kslope,y=.epred),fill="grey",col="grey40")+
  geom_point(data=tab_evo_DDD |> group_by(scenario,Mort,Fec) |> 
               summarise(trait=mean(mean_Kslope/mean_dmax,na.rm=TRUE),
                         slope=mean(start_Kslope)),
             aes(x=slope,trait),size=2,fill="white",pch=21)+
  facet_grid(rows=vars(paste0("*r<sub>0</sub>* = log(",Fec,")")),cols=vars(paste("*m* =",Mort)))+
  scale_x_continuous("initial dispersal density-dependence (*&Delta;<sub>K-0</sub>*)")+
  scale_y_continuous("relative dispersal density-dependence (*&Delta;<sub>K-0</sub> / d<sub>max</sub>*) after expansion")+
  theme_bw()+
  ggtitle(label="",subtitle="(only scenarios with heritable variation in *&alpha;* and *&beta;*)")+
  theme(legend.position = "none",
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(angle = 0),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    plot.subtitle = element_markdown()
  )
```

## evo models: dmax

```{r}
tab_evo_dmax <- filter(tab_evo, is.VP_dmax==1)
  
mod_dmax <- brm(bf(mean_dmax~ start_Kslope * Mort * Fec  + (1|scenario),
                    nlf(phi~1/exp(loginvphi)),
                        loginvphi ~ start_Kslope * Mort * Fec  + (1|scenario)),
                  family=Beta(link_phi="identity"),
                  data=tab_evo_dmax,backend="cmdstanr",
                seed=42,
                  prior=prior_beta
)
```

```{r}
fits_dmax=select(tab_evo_dmax,Mort,Fec) |> distinct() |> 
  expand_grid(start_Kslope=c(-5:5)/10) |> 
  add_epred_draws(mod_dmax,re_formula=NA)

tab_evo_dmax |>  
  ggplot()+
  geom_hline(yintercept = 0.5,lty=2) +
  geom_point(aes(x=start_Kslope,y=mean_dmax),col="palegreen",alpha=0.25)+
  stat_lineribbon(data=fits_dmax,aes(x=start_Kslope,y=.epred),fill="grey",col="grey40")+
  geom_point(data=tab_evo_dmax |> group_by(scenario,Mort,Fec) |> 
               summarise(trait=mean(mean_dmax,na.rm=TRUE),
                         slope=mean(start_Kslope)),
             aes(x=slope,trait),size=2,fill="white",pch=21)+
  facet_grid(rows=vars(paste0("*r<sub>0</sub>* = log(",Fec,")")),cols=vars(paste("*m* =",Mort)))+
  scale_x_continuous("initial dispersal density-dependence (*&Delta;<sub>K-0</sub>*)")+
  scale_y_continuous("dispersal capacity (*d<sub>max</sub>*) after expansion")+
  theme_bw()+
  theme_bw()+
  ggtitle(label="",subtitle="only scenarios with heritable variation in *d<sub>max</sub>*")+
  theme(legend.position = "none",
    strip.text.x = element_markdown(),
    strip.text.y = element_markdown(angle = 0),
    axis.title.x = element_markdown(),
    axis.title.y = element_markdown(),
    plot.subtitle = element_markdown()
  )
```