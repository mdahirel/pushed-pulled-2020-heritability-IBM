---
title: 'Pushed expansions and sources of variation- individual-based model, data analysis'
author: "Maxime Dahirel & Chlo√© Guicharnaud"
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

```{r load-packages}
library(MASS)
library(arm)
library(matrixStats)
library(MuMin)
library(tidyverse)
library(cowplot)
library(patchwork)


library(mgcv)
library(gratia)

library(here)
```

# Introduction

```{r}
raw_data <- read_csv(here("NetLogo_output","simulation_output.csv"))
```

We rewrite variance variables to be in 0/1 mode to not be distracted

```{r}
data<- raw_data  %>% 
  mutate(is.VP_dmax=as.numeric(VP_logit_dmax >0),
           is.VP_DDD=as.numeric(VP_slope >0))
```


# making sub data tables

a table with summary variables at the edge (we define edge as patch <5 patchs from tip, see suppl for justification)
```{r}
tab_edge<-data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor > front-5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    min_N=min(N_predispersal,na.rm=TRUE),
    max_N=max(N_predispersal,na.rm=TRUE),
    mean_dmax=weighted.mean(mean_dmax,N_predispersal,na.rm=TRUE),
    mean_slope=weighted.mean(mean_slope,N_predispersal,na.rm=TRUE),
    mean_midpoint=weighted.mean(mean_midpoint,N_predispersal,na.rm=TRUE),
    mean_d0=weighted.mean(mean_d0,N_predispersal,na.rm=TRUE),
    mean_avgslope=weighted.mean(mean_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_Kslope=weighted.mean(mean_slopeA_0_K,N_predispersal,na.rm=TRUE),
    mean_uncond=weighted.mean(mean_uncond_0_K,N_predispersal,na.rm=TRUE),
    mean_varslope=weighted.mean(var_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_vard0=weighted.mean(var_d0,N_predispersal,na.rm=TRUE),
    front=mean(front)
  ) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  mutate(range_N=max(max_N)-min(min_N)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD,
                          range_N),
              names_from=ticks,
              values_from=c(mean_dmax,mean_slope,mean_midpoint,
                            mean_d0,mean_avgslope,mean_Kslope,mean_uncond,
                            mean_varslope,mean_vard0,
                            front)) %>% 
  mutate(where="edge")
```

we do the same for core patches

```{r}
tab_core<-data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor < 5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    min_N=min(N_predispersal,na.rm=TRUE),
    max_N=max(N_predispersal,na.rm=TRUE),
    mean_dmax=weighted.mean(mean_dmax,N_predispersal,na.rm=TRUE),
    mean_slope=weighted.mean(mean_slope,N_predispersal,na.rm=TRUE),
    mean_midpoint=weighted.mean(mean_midpoint,N_predispersal,na.rm=TRUE),
    mean_d0=weighted.mean(mean_d0,N_predispersal,na.rm=TRUE),
    mean_avgslope=weighted.mean(mean_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_Kslope=weighted.mean(mean_slopeA_0_K,N_predispersal,na.rm=TRUE),
    mean_uncond=weighted.mean(mean_uncond_0_K,N_predispersal,na.rm=TRUE),
    mean_varslope=weighted.mean(var_slopeA_0_avg,N_predispersal,na.rm=TRUE),
    mean_vard0=weighted.mean(var_d0,N_predispersal,na.rm=TRUE),
    front=mean(front)
  ) %>% 
  ungroup() %>% 
  group_by(replicateID) %>% 
  mutate(range_N=max(max_N)-min(min_N)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = c(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD,
                          range_N),
              names_from=ticks,
              values_from=c(mean_dmax,mean_slope,mean_midpoint,
                            mean_d0,mean_avgslope,mean_Kslope,mean_uncond,
                            mean_varslope,mean_vard0,
                            front)) %>% 
  mutate(where="core")
```

we also extract separately variables at t0
```{r}
tab_start<-data %>% select(
  start_dmax,
  start_midpoint,
  start_slope,
  start_d0,
  start_avgslope=start_slopeA_0_avg,
  start_Kslope=start_slopeA_0_K,
  start_uncond=start_uncond_0_K,
  replicateID
) %>% 
  distinct()

```

finally we run another extraction to get information on genetic diversity decay, time to fixation
(earliest observation of front (defined as above) only containing one of the two neutral alleles
)
```{r}
tab_genet <- data %>% 
  group_by(replicateID,ticks) %>% 
  mutate(front=max(pxcor*(N_postdispersal>0))) %>% 
  filter(pxcor > front-5 ) %>%
  ungroup() %>% 
  group_by(replicateID,ticks,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(
    N_allele0=sum(N_allele0_post),
    N_allele1=sum(N_allele1_post)
  ) %>% 
  ungroup() %>% 
  mutate(edge_fix= N_allele0==0 | N_allele1==0) %>% 
  group_by(replicateID) %>% 
  mutate(time_to_fix=case_when(subset(edge_fix,ticks==20)==1 ~ 20,
                               subset(edge_fix,ticks==40)==1 ~ 40,
                               subset(edge_fix,ticks==60)==1 ~ 60,
                               subset(edge_fix,ticks==80)==1 ~ 80,
                               subset(edge_fix,ticks==100)==1 ~ 100,
                               subset(edge_fix,ticks==120)==1 ~ 120,
                               T~121)##not fixed yet at end of experiment
         ) %>% 
  ungroup() %>% 
  group_by(replicateID,dispersal_mortality,heritability,is.VP_dmax,is.VP_DDD) %>% 
  summarise(time_to_fix=unique(time_to_fix)) %>% 
  ungroup()
```

now we can mix and combine these datasets for analyses

# analysis of speed and genetic dynamics


```{r}
tab <-tab_edge %>% 
  left_join(tab_start) %>% 
  left_join(tab_genet) %>% 
  mutate(mortality=factor(dispersal_mortality)) %>% 
  mutate(advance=front_120-front_100) %>% 
  mutate(scale_d0_100=scale(mean_d0_100)[,1],
         scale_d0_start=scale(start_d0)[,1],
         s_avgslope_100=mean_avgslope_100/sd(mean_avgslope_100),
         s_avgslope_start=start_avgslope/sd(start_avgslope),
         s_Kslope_100=mean_Kslope_100/sd(mean_Kslope_100),
         s_Kslope_start=start_Kslope/sd(start_Kslope))
```

for both velocity and genetics, we compare 4 models:

- one with and one without the density-dependency variable (is knowledge of DDD needed to predict?)
- both taken at g100 and at the start of the experiment (is knowledge of evolution needed?)

## velocity evidence

patches are discrete entities, and speed is capped at one patch/generation. So let's start with binomial models:


```{r}


tab2 <-tab %>% 
  mutate(d0_eff=(1-dispersal_mortality)*mean_d0_100,
         r0_eff=log(5-(dispersal_mortality*d0_eff)*5),
         vf=2*(log(5)*0.5*d0_eff)^0.5,
         vf2=2*(r0_eff*0.5*d0_eff)^0.5) %>% 
  arrange(d0_eff)

tab2 %>% 
  filter(mean_avgslope_100>-0.05 & mean_avgslope_100<0.05) %>% 
  ggplot()+ #only slope close to 0
  geom_point(aes(d0_eff, ##use effective d0, accounting for motality
                 advance/20,col=mortality))+
  geom_line(aes(d0_eff,vf2))+
  geom_line(aes(d0_eff,vf),lty=2)+
  facet_wrap(~dispersal_mortality)
## shows that the continuum approx for v is goodish until it bumps into the v=1 boundary
## birzu says approach is very good when r0<<0 and d0/r0 >>1
## we're not in these conditions but still good enough

## we won't use our models to try and disentangle effect of mortality on effective d0 versus
## other effects, but nice to know it exists
```



```{r}
if(file.exists(here("R_output","models_velocity_binom.Rdata"))){
  # this if-else statement is avoid re-fitting a model if there is already one existing in R_output
  # to override, re-run and re-save manually the model by selecting only relevant code lines, instead of running the entire chunk, or delete the saved object
  load(here("R_output","models_velocity_binom.Rdata"))
  }else
    {
      
mod_100=gam(cbind(advance,20-advance)~
              s(mean_d0_100,by=mortality)+
              s(mean_avgslope_100,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))
###does better than the nonlinear at d0=nearly 0 because d0 is an average
### even when d0=0, some individuals may not be at d0

mod_100_K=gam(cbind(advance,20-advance)~
              s(mean_d0_100,by=mortality)+
              s(mean_Kslope_100,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_100_noDDD=gam(cbind(advance,20-advance)~
              s(mean_d0_100,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))


mod_00=gam(cbind(advance,20-advance)~
              s(start_d0,by=mortality)+
              s(start_avgslope,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_00_K=gam(cbind(advance,20-advance)~
              s(start_d0,by=mortality)+
              s(start_Kslope,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_00_noDDD=gam(cbind(advance,20-advance)~
              s(start_d0,by=mortality)+
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

mod_null=gam(cbind(advance,20-advance)~
              mortality, 
            family=binomial,data=subset(tab,advance>-1))

save(list=c("mod_100","mod_100_K","mod_100_noDDD",
            "mod_00","mod_00_K","mod_00_noDDD"), 
     file=here("R_output","models_velocity_binom.Rdata"))
    }
```

```{r}
gam_dev.expl=function(mod){
            return(summary(mod)$dev.expl)
}

gam_r2=function(mod){
            return(summary(mod)$r.sq)
          }


model.sel(list(mod_100=mod_100,
               mod_100_K=mod_100_K,
               mod_100_noDDD=mod_100_noDDD,
               mod_00=mod_00,
               mod_00_K=mod_00_K,
               mod_00_noDDD=mod_00_noDDD,
               mod_null=mod_null),extra=list(gam_dev.expl,gam_r2)) %>%  ##zero doubt the evol model is better
  rownames_to_column(var="model_name") %>% 
  as_tibble() %>% 
             mutate(is.evo=case_when(str_detect(model_name,"_100")~"after evolution (t = 100)",
                                     T~"before evolution (t = 0)"),
                    is.DDD=case_when(str_detect(model_name,"_noDDD")~"ignored",
                                     str_detect(model_name,"_K")~"included (shape-indep.)",
                                     T~"included (shape-dep.)")) %>% 
  filter(model_name!="mod_null") %>% 
  ggplot()+
  geom_point(aes(is.evo,AICc,
                         col=is.DDD),
                     size=3)+
  geom_line(aes(is.evo,AICc,
                group=is.DDD,
                col=is.DDD))+
  geom_hline(yintercept=AICc(mod_null),lty=2)+ ## the aicc of the mortality only model
  scale_x_discrete("when are trait covariables sampled?")+
  scale_y_continuous("AICc")+
  labs(col="Density dependence?")



draw(mod_100)
```



seems like data are underdispersed relative to the binomial, for all four models
see comment from bob carpenter here: https://discourse.mc-stan.org/t/underdispersed-binomial-glm/1540
the idea that if underdispersed relative to binomial, then not the result of independent bernoulli trials
which make sense, since proba of advancing to N+1 depends on # of individuals that advanced to N
qualitative ccl are the same anyway though
an ordinal model may be appropriate instead
see eg https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#underdispersion
so let's go with that as a check (supplement?)

```{r}

library(cmdstanr)
library(brms)

prior<-c(
  set_prior("normal(0,1.5)",class="b")
)

if(file.exists(here("R_output","models_velocity_ordinal.Rdata"))){
  load(here("R_output","models_velocity_ordinal.Rdata"))
  }else
    {
mod_00_ordinal=brm(bf((advance+1)~ ##we need the +1 because lower category must be 1 in an ordinal
          (scale_d0_start+s_avgslope_start)*mortality),
        family=sratio,data=tab,prior=prior,
        chains=4,seed=42,iter=2000,backend="cmdstanr")

mod_00_noDDD_ordinal=brm(bf((advance+1)~
          (scale_d0_start)*mortality),
        family=sratio,data=tab,prior=prior,
        chains=4,seed=42,iter=2000,backend="cmdstanr")


mod_100_ordinal=brm(bf((advance+1)~
          (scale_d0_100+s_avgslope_100)*mortality),
        family=sratio,data=tab,prior=prior,
        chains=4,seed=42,iter=2000,backend="cmdstanr")

mod_100_noDDD_ordinal=brm(bf((advance+1)~
          (scale_d0_100)*mortality),
        family=sratio,data=tab,prior=prior,
        chains=4,seed=42,iter=2000,backend="cmdstanr")

save(list=c("mod_100_ordinal","mod_100_noDDD_ordinal",
            "mod_00_ordinal","mod_00_noDDD_ordinal"), 
     file=here("R_output","models_velocity_ordinal.Rdata"))
    }
```

## genetic evidence

```{r}
if(file.exists(here("R_output","models_diversity.Rdata"))){
  load(here("R_output","models_diversity.Rdata"))
  }else
    {
 
tab$fixinterval=ordered(tab$time_to_fix,levels=sort(unique(tab$time_to_fix)))

mod_div_00=polr(fixinterval~
                     mortality+mortality:(scale_d0_start+s_avgslope_start),
        data=filter(tab,front_120>0))#one front did not advance)    

mod_div_00_K=polr(fixinterval~
                     mortality+mortality:(scale_d0_start+s_Kslope_start),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_00_noDDD=polr(fixinterval~
                     mortality+mortality:(scale_d0_start),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_100=polr(fixinterval~
                     mortality+mortality:(scale_d0_100+s_avgslope_100),
        data=filter(tab,front_120>0))#one front did not advance)    

mod_div_100_K=polr(fixinterval~
                     mortality+mortality:(scale_d0_100+s_Kslope_100),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_100_noDDD=polr(fixinterval~
                     mortality+mortality:(scale_d0_100),
        data=filter(tab,front_120>0))#one front did not advance) 

mod_div_null=polr(fixinterval~
                     mortality,
        data=filter(tab,front_120>0))#one front did not advance) 





save(list=c("mod_div_100","mod_div_100_K","mod_div_100_noDDD",
            "mod_div_00","mod_div_00_K","mod_div_00_noDDD"), 
     file=here("R_output","models_diversity.Rdata"))
    }
```


```{r}

model.sel(list(mod_div_100=mod_div_100,
               mod_div_100_K=mod_div_100_K,
               mod_div_100_noDDD=mod_div_100_noDDD,
               mod_div_00=mod_div_00,
               mod_div_00_K=mod_div_00_K,
               mod_div_00_noDDD=mod_div_00_noDDD)) %>%  ##zero doubt the evol model is better
  rownames_to_column(var="model_name") %>% 
  as_tibble() %>% 
             mutate(is.evo=case_when(str_detect(model_name,"_100")~"after evolution (t = 100)",
                                     T~"before evolution (t = 0)"),
                    is.DDD=case_when(str_detect(model_name,"_noDDD")~"ignored",
                                     str_detect(model_name,"_K")~"included (shape-indep.)",
                                     T~"included (shape-dep.)")) %>% 
  ggplot()+
  geom_point(aes(is.evo,AICc,
                         col=is.DDD),
                     size=3)+
  geom_line(aes(is.evo,AICc,
                group=is.DDD,
                col=is.DDD))+
  geom_hline(yintercept=AICc(mod_div_null),lty=2)+ ## the aicc of the mortality only model
  scale_x_discrete("when are trait covariables sampled?")+
  scale_y_continuous("AICc")+
  labs(col="Density dependence?")


```

# analyse evolution

our main tool: the plot y-x~x where y=trait after evol, x=trait at t0, deviation from nthe line y-x=0 indicate evolution



```{r}
tab_evol<- rbind(tab_edge,tab_core) %>% ##check the join is correct
  left_join(tab_start) %>% 
  mutate(group=paste(dispersal_mortality, is.VP_DDD,is.VP_dmax,heritability,where))
```


```{r}
tab_evolx <-tab_evol %>% 
  filter(where=="edge")  %>% 
  mutate(start_avgslope_binned=round(2*start_avgslope,1)/2,
         start_d0_binned=round(2*start_d0,1)/2) 

tab_evolx %>% 
  group_by(dispersal_mortality, heritability,start_avgslope_binned,
           is.VP_dmax,is.VP_DDD) %>% 
  summarise(mean_change=mean(mean_avgslope_100-start_avgslope),
            sd_change=sd(mean_avgslope_100-start_avgslope)) %>% 
  ggplot()+
    geom_hline(yintercept = 0,lty=2)+
    geom_point(data=tab_evolx,
               aes(start_avgslope,
                                 mean_avgslope_100-start_avgslope,
                                 col=where),alpha=0.2)+
  geom_pointrange(aes(x=start_avgslope_binned,
                      y=mean_change,
                      ymin=mean_change-sd_change,
                      ymax=mean_change+sd_change))+
    facet_grid(rows=vars(dispersal_mortality,paste("Vdmax",is.VP_dmax)),
               cols=vars(heritability,paste("Vddd",is.VP_DDD)))

tab_evolx %>% 
  group_by(dispersal_mortality, heritability,start_d0_binned,
           is.VP_dmax,is.VP_DDD) %>% 
  summarise(mean_change=mean(mean_d0_100-start_d0),
            sd_change=sd(mean_d0_100-start_d0)) %>% 
  ggplot()+
    geom_hline(yintercept = 0,lty=2)+
    geom_point(data=tab_evolx,
               aes(start_d0,
                                 mean_d0_100-start_d0,
                                 col=where),alpha=0.2)+
  geom_pointrange(aes(x=start_d0_binned,
                      y=mean_change,
                      ymin=mean_change-sd_change,
                      ymax=mean_change+sd_change))+
    facet_grid(rows=vars(dispersal_mortality,paste("Vdmax",is.VP_dmax)),
               cols=vars(heritability,paste("Vddd",is.VP_DDD)))


tab_evolx %>% 
  group_by(dispersal_mortality, heritability,
           is.VP_dmax,is.VP_DDD) %>% 
  summarise(mean_change=mean(mean_dmax_100-start_dmax),
            sd_change=sd(mean_dmax_100-start_dmax)) %>% 
  ggplot()+
    geom_hline(yintercept = 0,lty=2)+
    geom_jitter(data=tab_evolx,
               aes(0,
                                 mean_dmax_100-start_dmax,
                                 col=where),alpha=0.2)+
  geom_pointrange(aes(x=0,
                      y=mean_change,
                      ymin=mean_change-sd_change,
                      ymax=mean_change+sd_change))+
    facet_grid(rows=vars(dispersal_mortality,paste("Vdmax",is.VP_dmax)),
               cols=vars(heritability,paste("Vddd",is.VP_DDD)))
```


