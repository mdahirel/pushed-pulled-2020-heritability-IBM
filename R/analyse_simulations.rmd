---
title: 'Pushed expansions and heritability- individual-based model, data analysis'
author: "Maxime Dahirel & Chlo√© Guicharnaud"
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

```{r load-packages}
library(nlrx)
library(arm)
library(tidyverse)
library(cowplot)
library(here)
```

# Introduction

<!--to consider, for sensitivity: test a range of lower fecundities, test a more continuous range of h2 or mortalities, test narrower VPs?, or zero variability in dmax?-->

```{r}
data <- read_csv(here("NetLogo_output","model-output.csv"))
```

<!--the classical result that costs = more DDD was in contexts where dmax and midpoint did not evolve-->
<!-- hyper important to understand eco-evo dynamics: check that N=0 cells within pops are not deleted-->

<!--for genetic diversity: try to analyse at replicate level to do correlation with adaptive traits? so need to use binomial model on p to manage fixation
with h as latent variable // use "solve h=2*p*(1-p) for p" in wolfram to find an expression for p=f(h)// and use this in a nonlinear brms model???
nope: won't work, because two solutions: one that gives p, one that gives 1-p-->
<!--go back to h, but either with gaussian for 0 (bounded??)
with ordered bins or censoring (https://discourse.mc-stan.org/t/zero-one-inflated-beta-as-censored-beta/8468/3) or waiting for the "marginal" approach (https://github.com/paul-buerkner/brms/issues/641)-->

v = alpha*vf, where alpha the pushiness ratio
vf = 2 * sqrt ( 0.5 * d0 * r0) + epsilon

v = alpha * 2 * sqrt(r0) * sqrt(0.5 * d0) + epsilon

v = a sqrt(0.5 * d0) + b (still works even if there are multiplicative constants I ignore, as long as they are constant)

linear regression where the slope is proportional to the pushiness ratio (not necessary =)
should work because r0 is constant, K is constant (see for how the "correction" depends on K only if the noise is f(K) as it is in poisson; in brunet derrida)
and large variation in d0 due to evol

v/sqrt(0.5*d0) potentially enough to use as a pushiness index to a transfo

look at v/sqrt(0.5*d0) ~ mean_avgslope0_K

hopefully good (not necessarily linear) correlation

treat speed as a binomial variable in analyses, the % of patches available visited

front = binomial(speed, generations)
(works only because speed<=1, and allow correct prediction (no >1))


```{r}
test<-data %>% 
    mutate(is.VP_dmax=as.numeric(VP_logit_dmax >0),
           is.VP_DDD=as.numeric(VP_slope >0)) %>% 
    filter(pxcor ==(present_front -1) & ticks==100) %>% 
  mutate(mortality=factor(dispersal_mortality))

mod=gam(cbind(present_front,100-present_front)~s(mean_d0,mean_avgslope0_K)+mortality,family=binomial,data=test)

gratia::draw(mod)

mod=glm(cbind(present_front,100-present_front)~scale(mean_d0)*scale(mean_avgslope0_K)*mortality,family=binomial,data=test)

## extremely simple model, but explains a lot, confirms association between synthetic slope post evol and end speed, confirm slope as measure of pushiness
```



```{r}
data %>% 
  mutate(is.VP_dmax=VP_logit_dmax >0,
         is.VP_DDD=VP_slope >0) %>% 
  filter(ticks==100 & pxcor ==(present_front -1)) %>% 
  ggplot()+
  geom_boxplot(aes(factor(slope_start),mean_avgslope0_K,col=factor(midpoint_start)))+
  facet_grid(rows=vars(dispersal_mortality,is.VP_dmax),
                       cols=vars(heritability,is.VP_DDD))+
  geom_hline(yintercept = 0)
```

```{r}
data %>% 
  mutate(is.VP_dmax=VP_logit_dmax >0,
         is.VP_DDD=VP_slope >0) %>% 
  filter(pxcor ==(present_front -1)) %>% 
  ggplot()+
  geom_point(aes(sqrt(0.5*mean_d0),present_front/ticks,col=factor(mean_avgslope0_K>0)))+
  geom_hline(yintercept = 0)+
  facet_wrap(~ticks)
```

```{r}
data %>% 
  mutate(is.VP_dmax=VP_logit_dmax >0,
         is.VP_DDD=VP_slope >0) %>% 
  filter(pxcor ==(present_front -1)) %>% 
  ggplot()+
  geom_point(aes(mean_d0,mean_avgslope0_K, col = present_front/ticks))+
  geom_hline(yintercept = 0)+
  facet_wrap(~ticks)
```


```{r}
data %>% filter(pxcor== (present_front-1) & ticks==100) %>% ggplot()+
  geom_boxplot(aes(factor(slope_start),mean_avgslope0_K,col=factor(midpoint_start)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(dispersal_mortality,VP_logit_dmax>0),
                       cols=vars(heritability,VP_slope>0))
```

```{r}
data %>% filter(pxcor> (present_front-10) & ticks==100) %>% ggplot()+
  geom_boxplot(aes(factor(slope_start),present_front/ticks/median_dmax,col=factor(midpoint_start)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(dispersal_mortality,reproduction),
             cols=vars(heritability,VP_slope>0))+
  coord_cartesian(ylim=c(0,2))
```


```{r}
data %>% filter(pxcor> (present_front-5) & ticks==100) %>% ggplot()+
  geom_boxplot(aes(factor(slope_start),var_genotype_logit_dmax,col=factor(midpoint_start)))+
  geom_hline(yintercept=c(0,1))+
  facet_grid(rows=vars(dispersal_mortality,reproduction),
             cols=vars(heritability,VP_slope>0))
```

```{r}
data %>% filter(pxcor> (present_front-10) & ticks==100) %>% ggplot()+
  geom_point(aes(mean_midpoint,mean_avgslope0_K,col=factor(paste(slope_start,midpoint_start))))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(dispersal_mortality,reproduction),
             cols=vars(heritability,VP_slope>0))
```


```{r}
data %>% filter(pxcor> (present_front-5) & ticks==100 & heritability==1) %>% ggplot()+
  geom_point(aes(mean_midpoint+3*mean_slope,mean_avgslope0_K,col=factor(dispersal_mortality)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(slope_start),
             cols=vars(midpoint_start))
```

```{r}
data %>% filter(pxcor> (present_front-10) & ticks==100 & heritability==1) %>% ggplot()+
  geom_boxplot(aes(factor(pxcor-present_front),N_predispersal,col=factor(dispersal_mortality)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(slope_start),
             cols=vars(midpoint_start))
```


```{r}
data %>% filter(pxcor> (present_front-10) & ticks==100 & heritability==1) %>% ggplot()+
  geom_point(aes(mean_avgslope0_K,N_predispersal,col=factor(dispersal_mortality)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(slope_start),
             cols=vars(midpoint_start))
```

```{r}
data %>% filter(pxcor> (present_front-10) & heritability==1) %>%
  group_by(reproduction,ticks,dispersal_mortality,heritability,slope_start,midpoint_start) %>% 
  mutate(H = 2*(N_allele1_pre/(N_allele1_pre+N_allele0_pre))*(N_allele0_pre/(N_allele1_pre+N_allele0_pre))) %>% 
  summarise(meanH=mean(H,na.rm=TRUE)) %>% 
  ggplot()+
  geom_line(aes(ticks,meanH,col=factor(paste(reproduction,dispersal_mortality))))+
  facet_grid(rows=vars(slope_start),
             cols=vars(midpoint_start))
```

```{r}
data %>% filter(pxcor> (present_front-10) & heritability==1 & ticks==100) %>%
  group_by(reproduction,ticks,dispersal_mortality,heritability,slope_start,midpoint_start) %>% 
  ggplot()+
  geom_point(aes(present_front,mean_avgslope0_K,col=factor(paste(reproduction,dispersal_mortality))))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(slope_start),
             cols=vars(midpoint_start))
```

```{r}
data %>% filter(pxcor> (present_front-5) & ticks==100 & slope_start==6) %>% 
  expand_grid(x=c(0:10/10)) %>% 
  ggplot()+
  geom_line(aes(x,median_dmax/(1+exp(-median_slope*(x-median_midpoint))),group=paste(replicateID,pxcor),col=factor(midpoint_start)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(dispersal_mortality,reproduction),
             cols=vars(heritability,VP_slope>0))
```


```{r}
data %>% filter(pxcor== (present_front-1)) %>% 
  ggplot()+
  geom_boxplot(aes(factor(ticks),mean_avgslope0_K,col=factor(midpoint_start)))+
  geom_hline(yintercept=c(0))+
  facet_grid(rows=vars(dispersal_mortality,slope_start),
             cols=vars(heritability,VP_slope>0))
```


```{r}
data %>% filter(pxcor== (present_front-1)) %>%
  mutate(v=present_front/ticks) %>% 
  mutate(vf= 2*sqrt(
    median_d0*(1-dispersal_mortality)*0.5*
    log(5*(1-median_d0*dispersal_mortality))
  )) %>% 
  ggplot()+
  geom_boxplot(aes(factor(ticks),v/vf,col=factor(midpoint_start)))+
  geom_hline(yintercept=c(1,1.06))+
  facet_grid(rows=vars(dispersal_mortality,slope_start),
             cols=vars(heritability,VP_slope>0))+
  coord_cartesian(ylim=c(0,2))
```

```{r}
test=data %>% select(replicateID,ticks,pxcor) %>% 
  filter(ticks==50 |ticks==100) %>% 
  group_by(replicateID,ticks) %>% 
  summarise(front=max(pxcor)) %>% 
  ungroup() %>% 
  pivot_wider(names_from=ticks,values_from = front) %>% 
  mutate(v50_100=(`100`-`50`)/50) %>% 
  select(replicateID,v50_100)
```

```{r}
data %>% filter(pxcor== (present_front-1) & ticks ==50) %>% 
  left_join(test) %>% 
  ggplot()+
  geom_point(aes(1-N_sedentary/N_predispersal,mean_d0,col=mean_avgslope0_K))+
  facet_grid(rows=vars(dispersal_mortality,mean_avgslope0_K>0),
             cols=vars(heritability,VP_slope>0))+
  geom_abline(intercept=0,slope=1)
```

```{r}
test2<-data %>% 
  group_by(dispersal_mortality,reproduction,heritability,VP_slope,replicateID,slope_start,midpoint_start,ticks) %>% 
  filter(N_postdispersal>(0.5*K)) %>% 
  summarise(midfront=max(pxcor),front=max(present_front)) %>% 
  ungroup()
```

```{r}
data %>% filter(pxcor== (present_front-1) & ticks ==100) %>% 
  ggplot()+
  geom_boxplot(aes(factor(slope_start),N_postdispersal,col=factor(midpoint_start)))+
  facet_grid(rows=vars(dispersal_mortality,VP_logit_dmax>0),
                       cols=vars(heritability,VP_slope>0))
  geom_abline(intercept=0,slope=1)+
  coord_cartesian(ylim=c(-5,10))
```
```

